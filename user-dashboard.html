<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard | Promote With Us</title>
    <meta name="description" content="User dashboard for Promote With Us">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #164069;
            --secondary: #20c5b5;
            --accent: #20c5b5;
            --light: #f8f9ff;
            --dark: #0a0e27;
            --gradient-main: linear-gradient(135deg, #164069 0%, #20c5b5 100%);
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #164069 50%, #0db8a1 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #0f1630 0%, #14213a 100%);
            border-bottom: 1px solid rgba(32, 197, 181, 0.2);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .navbar h1 {
            color: #20c5b5;
            font-size: 24px;
            font-weight: 700;
        }

        .navbar .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .navbar .username {
            color: #cfd8df;
            font-size: 14px;
            font-weight: 600;
        }

        .navbar .logout-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .navbar .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.3);
        }

        /* Profile Dropdown Styles */
        .profile-menu-container {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-btn:hover {
            background: rgba(32, 197, 181, 0.2);
            transform: scale(1.05);
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: linear-gradient(135deg, #0f1630 0%, #14213a 100%);
            border: 1px solid rgba(32, 197, 181, 0.3);
            border-radius: 10px;
            min-width: 200px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            display: none;
            z-index: 1000;
            overflow: hidden;
            margin-top: 10px;
            animation: slideDown 0.3s ease;
        }

        .profile-dropdown.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-dropdown-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(32, 197, 181, 0.2);
            text-align: center;
        }

        .profile-dropdown-header .username {
            color: #20c5b5;
            font-weight: 700;
            font-size: 15px;
            display: block;
            margin-bottom: 5px;
        }

        .profile-dropdown-header .email {
            color: #9fbfc6;
            font-size: 12px;
        }

        .profile-dropdown-item {
            padding: 12px 20px;
            color: #cfd8df;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
        }

        .profile-dropdown-item:hover {
            background: rgba(32, 197, 181, 0.2);
            color: #20c5b5;
        }

        .profile-dropdown-item.logout:hover {
            background: rgba(245, 87, 108, 0.2);
            color: #f5576c;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .welcome-section {
            background: linear-gradient(135deg, #0f1630 0%, #14213a 100%);
            border: 1px solid rgba(32, 197, 181, 0.3);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .welcome-section h2 {
            color: #20c5b5;
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .welcome-section p {
            color: #cfd8df;
            font-size: 16px;
            line-height: 1.6;
        }

        .content {
            background: linear-gradient(135deg, #0f1630 0%, #14213a 100%);
            border: 1px solid rgba(32, 197, 181, 0.3);
            border-radius: 15px;
            padding: 40px;
            min-height: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 20px;
        }

        .plan-card {
            background: linear-gradient(135deg, #0a1929 0%, #0f2847 100%);
            border: 1px solid rgba(32, 197, 181, 0.4);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .plan-card:hover {
            transform: translateY(-4px);
            border-color: rgba(32, 197, 181, 0.7);
            box-shadow: 0 12px 35px rgba(32, 197, 181, 0.2);
        }

        .plan-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #20c5b5 0%, #0db8a1 100%);
        }

        .plan-card-header {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(32, 197, 181, 0.2);
        }

        .plan-card-title {
            color: #20c5b5;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .plan-card-tier {
            color: #9fbfc6;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .plan-detail {
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plan-detail-label {
            color: #9fbfc6;
            font-size: 13px;
            font-weight: 600;
        }

        .plan-detail-value {
            color: #cfd8df;
            font-size: 14px;
            font-weight: 700;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .time-remaining {
            background: linear-gradient(135deg, rgba(32, 197, 181, 0.1), rgba(13, 184, 161, 0.1));
            border: 1px solid rgba(32, 197, 181, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            text-align: center;
        }

        .time-remaining-label {
            color: #9fbfc6;
            font-size: 12px;
            display: block;
            margin-bottom: 5px;
        }

        .time-remaining-value {
            color: #20c5b5;
            font-size: 16px;
            font-weight: 700;
        }

        .plan-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .plan-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .plan-btn-upgrade {
            background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%);
            color: #042;
        }

        .plan-btn-upgrade:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(32, 197, 181, 0.3);
        }

        .content-placeholder {
            color: #9fbfc6;
            font-size: 16px;
            text-align: center;
            padding: 60px 20px;
        }

        .content-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading-text {
            color: #20c5b5;
            text-align: center;
            padding: 40px;
            font-size: 14px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            padding: 20px;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-dialog {
            background: linear-gradient(135deg, #0f1630, #14213a);
            padding: 30px;
            border-radius: 15px;
            width: 450px;
            max-width: 92%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            right: 15px;
            top: 12px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .modal-title {
            color: #20c5b5;
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 700;
        }

        .modal-description {
            color: #9fbfc6;
            margin: 0 0 20px 0;
            font-size: 14px;
        }

        .form-group {
            margin-top: 15px;
        }

        .form-label {
            display: block;
            color: #cfd8df;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #0a1929;
            background: #0a1929;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
        }

        .form-select {
            cursor: pointer;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
            max-height: 150px;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: #cfd8df;
            font-size: 14px;
            font-weight: 600;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #20c5b5;
        }

        .submit-btn {
            margin-top: 20px;
            width: 100%;
            background: linear-gradient(135deg, #20c5b5, #0db8a1);
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: #042;
            font-weight: 700;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .form-message {
            color: #ffb3b3;
            font-size: 13px;
            margin-top: 12px;
            min-height: 18px;
            text-align: center;
        }

        .hidden-section {
            display: none;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }

            .navbar .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .container {
                padding: 20px 15px;
            }

            .welcome-section,
            .content {
                padding: 25px;
            }

            .welcome-section h2 {
                font-size: 22px;
            }

            .plans-grid {
                grid-template-columns: 1fr;
            }

            .modal-dialog {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <h1>üë§ User Dashboard</h1>
        <div class="user-info">
            <div class="profile-menu-container">
                <button class="profile-btn" id="profileBtn" onclick="toggleProfileDropdown()">üë§</button>
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <span class="username" id="profileUsername">User</span>
                        <span class="email" id="profileEmail">user@email.com</span>
                    </div>
                    <button class="profile-dropdown-item" onclick="openUserProfile()">
                        <span>üë§</span>
                        <span>View Profile</span>
                    </button>
                    <button class="profile-dropdown-item" onclick="handleRefresh()">
                        <span>üîÑ</span>
                        <span>Refresh</span>
                    </button>
                    <button class="profile-dropdown-item logout" onclick="handleUserLogout()">
                        <span>üö™</span>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h2>Welcome to Your Dashboard</h2>
            <p>View and manage your selected plans below</p>
        </div>

        <!-- Payment Summary Section -->
        <div id="dashboardPaymentSummary" style="background: linear-gradient(135deg, #0f1630 0%, #14213a 100%); border: 1px solid rgba(32, 197, 181, 0.2); border-radius: 12px; padding: 18px 24px; margin-bottom: 28px; box-shadow: 0 4px 18px rgba(32,197,181,0.07); display: flex; align-items: center; justify-content: space-between; gap: 18px;">
            <div id="dashboardPaymentInfo" style="color:#cfd8df; font-size:15px;">
                Total: <strong id="dashboardTotalAmount" style="color:#20c5b5;">‚Äî</strong> &nbsp; ‚Ä¢ &nbsp; Paid: <strong id="dashboardPaidAmount" style="color:#cfd8df;">‚Äî</strong> &nbsp; ‚Ä¢ &nbsp; Remaining: <strong id="dashboardRemainingAmount" style="color:#f6a623;">‚Äî</strong>
            </div>
            <div>
                <button onclick="openUserPayments()" style="background:transparent; border:1px solid rgba(255,255,255,0.06); color:#cfd8df; padding:8px 16px; border-radius:6px; font-weight:700;">View Payments</button>
            </div>
        </div>

        <!-- Content Section -->
        <div class="content">
            <div id="plansContainer" class="loading-text">Loading your plans...</div>
        </div>
    </div>

    <!-- Upgrade Plan Modal -->
    <div id="upgrade-plan-modal" class="modal hidden" role="dialog" aria-hidden="true" aria-labelledby="upgrade-modal-title">
        <div class="modal-dialog">
            <button class="modal-close" onclick="closeUpgradePlanModal()" aria-label="Close">&times;</button>
            <h3 class="modal-title" id="upgrade-modal-title">Upgrade or Add Plan</h3>
            <p class="modal-description">Update your plan details or add a new plan</p>
            
            <form id="upgradePlanForm">
                <div class="form-group">
                    <label for="upgrade_companyName" class="form-label">Company Name *</label>
                    <input id="upgrade_companyName" name="companyName" type="text" required placeholder="Your Company Name" class="form-input" />
                </div>

                <div class="form-group">
                    <label for="upgrade_mobile" class="form-label">Mobile Number *</label>
                    <input id="upgrade_mobile" name="mobile" type="text" required placeholder="+91 98765 43210" pattern="[0-9+\-() ]{6,20}" class="form-input" />
                </div>

                <div class="form-group">
                    <label for="upgrade_email" class="form-label">Email Address *</label>
                    <input id="upgrade_email" name="email" type="email" required placeholder="you@company.com" class="form-input" />
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; color: #cfd8df; font-size: 14px; font-weight: 600; cursor: pointer; gap: 10px;">
                        <input type="checkbox" id="upgrade_combine_plans_toggle" style="width: 18px; height: 18px; cursor: pointer; accent-color: #20c5b5;" />
                        Combine Multiple Plans
                    </label>
                </div>

                <div id="upgrade_combined_plans_section" class="form-group hidden-section">
                    <label for="upgrade_plan_count_select" class="form-label">How many plans do you want to combine?</label>
                    <select id="upgrade_plan_count_select" class="form-select">
                        <option value="">-- Select Number --</option>
                        <option value="2">2 Plans</option>
                        <option value="3">3 Plans</option>
                    </select>
                    <div id="upgrade_combined_plans_dropdowns" style="display: flex; flex-direction: column; gap: 20px; margin-top: 15px;"></div>
                </div>

                <div id="upgrade_single_plan_section" class="form-group">
                    <label for="upgrade_plan_selection" class="form-label">Select Your Plan</label>
                    <select id="upgrade_plan_selection" name="plan" class="form-select">
                        <option value="">-- Choose a Plan --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="upgrade_requirements" class="form-label">Your Requirements (Optional)</label>
                    <textarea id="upgrade_requirements" name="requirements" placeholder="Tell us about your project, features you need, design preferences, etc." class="form-textarea"></textarea>
                </div>

                <button type="submit" class="submit-btn">Save Changes & Update Plan</button>
                <div id="upgradeModalMsg" class="form-message"></div>
            </form>
        </div>
    </div>

    <!-- Request Update Modal -->
    <div id="update-request-modal" class="modal hidden" role="dialog" aria-hidden="true" aria-labelledby="update-request-modal-title">
        <div class="modal-dialog">
            <button class="modal-close" onclick="closeUpdateRequestModal()" aria-label="Close">&times;</button>
            <h3 class="modal-title" id="update-request-modal-title">Request Plan Upgrade</h3>
            <p class="modal-description">Submit your plan upgrade request to the admin</p>
            
            <form id="updateRequestForm">
                <div class="form-group">
                    <label for="request_companyName" class="form-label">Company Name *</label>
                    <input id="request_companyName" name="companyName" type="text" required placeholder="Your Company Name" class="form-input" readonly />
                </div>

                <div class="form-group">
                    <label for="request_mobile" class="form-label">Mobile Number *</label>
                    <input id="request_mobile" name="mobile" type="text" required placeholder="+91 98765 43210" pattern="[0-9+\-() ]{6,20}" class="form-input" />
                </div>

                <div class="form-group">
                    <label for="request_email" class="form-label">Email Address *</label>
                    <input id="request_email" name="email" type="email" required placeholder="you@company.com" class="form-input" readonly />
                </div>

                <div class="form-group">
                    <label for="request_currentPlan" class="form-label">Current Plan</label>
                    <input id="request_currentPlan" name="currentPlan" type="text" placeholder="Your current plan" class="form-input" readonly />
                </div>

                <div class="form-group">
                    <label for="request_newPlan" class="form-label">Requested New Plan *</label>
                    <select id="request_newPlan" name="newPlan" required class="form-input" style="cursor: pointer;">
                        <option value="">-- Choose a Plan --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="request_description" class="form-label">Upgrade Description *</label>
                    <textarea id="request_description" name="description" required placeholder="Describe what changes or upgrades you'd like to make..." class="form-textarea"></textarea>
                </div>

                <button type="submit" class="submit-btn">üì® Send Upgrade Request</button>
                <div id="updateRequestMsg" class="form-message"></div>
            </form>
        </div>
    </div>

    <script>
        let allPlans = [];
        let currentUserData = null;

        // Load plans on page load
        async function loadPlansData() {
            try {
                const response = await fetch(`/api/plans?t=${Date.now()}`);
                const data = await response.json();
                allPlans = data.allPlans || data.plans || [];
                if (typeof allPlans === 'object' && !Array.isArray(allPlans)) {
                    allPlans = Object.values(allPlans).flat();
                }
                populateUpgradePlanDropdowns();
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        // Populate upgrade plan dropdowns
        function populateUpgradePlanDropdowns() {
            const planSelect = document.getElementById('upgrade_plan_selection');
            planSelect.innerHTML = '<option value="">-- Choose a Plan --</option>';
            
            allPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.name;
                option.textContent = `${plan.tier} - ${plan.category} (${plan.price})`;
                planSelect.appendChild(option);
            });
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Calculate time remaining
        function calculateTimeRemaining(dueDate) {
            const due = new Date(dueDate);
            const now = new Date();
            const diff = due - now;
            
            if (diff <= 0) return 'Expired';
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `${days} day${days !== 1 ? 's' : ''} ${hours} hour${hours !== 1 ? 's' : ''}`;
            } else {
                return `${hours} hour${hours !== 1 ? 's' : ''}`;
            }
        }

        // Load user data and display plans
        async function loadUserPlans() {
            const username = localStorage.getItem('username');
            if (!username) {
                document.getElementById('plansContainer').innerHTML = `
                    <div class="content-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" fill="#20c5b5" opacity="0.5"/>
                        </svg>
                        <p>Not logged in</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const leads = data.leads || [];
                
                // Find user's lead record (allow username, brandName or email match)
                const usernameLower = username.toLowerCase();
                const userLead = leads.find(lead => 
                    (lead.username && lead.username.toLowerCase() === usernameLower) || 
                    (lead.brandName && lead.brandName.toLowerCase() === usernameLower) ||
                    (lead.email && lead.email.toLowerCase() === usernameLower)
                );
                
                // If the user's account has been blacklisted, block access from the user panel
                if (userLead && userLead.blacklisted) {
                    document.getElementById('plansContainer').innerHTML = `
                        <div class="content-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:72px;height:72px;margin-bottom:18px;">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill="#b71c1c" opacity="0.12"/>
                                <path d="M12 7a5 5 0 100 10 5 5 0 000-10zm0-4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8z" fill="#b71c1c"/>
                            </svg>
                            <h3 style="color:#b71c1c; margin-bottom:8px;">Account blocked</h3>
                            <p style="color:#9fbfc6; max-width:520px;">Your account has been suspended and access to the dashboard is restricted. If you believe this is an error, please contact us at <strong>promotewithus6@gmail.com</strong>.</p>
                        </div>
                    `;
                    return;
                }

                if (!userLead) {
                    document.getElementById('plansContainer').innerHTML = `
                        <div class="content-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" fill="#20c5b5" opacity="0.5"/>
                            </svg>
                            <p>No plans found. Visit home to select a plan!</p>
                        </div>
                    `;
                    return;
                }

                currentUserData = userLead;
                updateProfileInfo();
                displayPlans(userLead);
            } catch (error) {
                console.error('Error loading user plans:', error);
                document.getElementById('plansContainer').innerHTML = `
                    <div class="content-placeholder">
                        <p>Error loading plans. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        // Display plans in cards
        function displayPlans(userLead) {
            const container = document.getElementById('plansContainer');
            // Update dashboard payment summary
            const total = userLead.totalAmount !== undefined ? `‚Çπ${userLead.totalAmount}` : '‚Äî';
            const paid = userLead.paidAmount || 0;
            const remaining = (userLead.remainingAmount !== null && userLead.remainingAmount !== undefined) ? `‚Çπ${userLead.remainingAmount}` : '‚Äî';
            document.getElementById('dashboardTotalAmount').textContent = total;
            document.getElementById('dashboardPaidAmount').textContent = `‚Çπ${paid}`;
            document.getElementById('dashboardRemainingAmount').textContent = remaining;
            const plans = userLead.plans || [];
            const planNames = userLead.plan ? [userLead.plan] : [];
            
            if (planNames.length === 0 && plans.length === 0) {
                container.innerHTML = `
                    <div class="content-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" fill="#20c5b5" opacity="0.5"/>
                        </svg>
                        <p>No plans selected yet. Start by selecting a plan!</p>
                    </div>
                `;
                return;
            }

            // Combine plan names and plan objects
            const allPlanNames = [...planNames, ...plans.map(p => p.name || p.plan)];
            const planDetails = [];

            // Find plan details from allPlans (case-insensitive matching)
            allPlanNames.forEach(planName => {
                const planDetail = allPlans.find(p => 
                    p.name && p.name.toLowerCase() === planName.toLowerCase()
                );
                if (planDetail) {
                    planDetails.push(planDetail);
                }
            });

            if (planDetails.length === 0) {
                container.innerHTML = `
                    <div class="content-placeholder">
                        <p>Plan information not available.</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="plans-grid">';

            planDetails.forEach((plan, index) => {
                // Use admin-set dates or defaults
                const startDate = userLead.planStartDate ? new Date(userLead.planStartDate) : new Date(userLead.created_at);
                const endDate = userLead.planEndDate ? new Date(userLead.planEndDate) : new Date(new Date(userLead.created_at).getTime() + (30 * 24 * 60 * 60 * 1000));
                const timeRemaining = calculateTimeRemaining(endDate);
                const hasOffer = plan.offerPercentage && plan.originalRate;

                // Payment details for this user
                const paid = userLead.paidAmount !== undefined ? `‚Çπ${userLead.paidAmount}` : '‚Äî';
                const remaining = userLead.remainingAmount !== undefined && userLead.remainingAmount !== null ? `‚Çπ${userLead.remainingAmount}` : '‚Äî';

                html += `
                    <div class="plan-card" style="position: relative;">
                        ${hasOffer ? `
                            <div style="position: absolute; top: 20px; right: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 8px 12px; border-radius: 6px; font-weight: 700; font-size: 13px; box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3); z-index: 10;">
                                üéâ ${plan.offerPercentage}% OFF
                            </div>
                        ` : ''}
                        <div class="plan-card-header">
                            <div class="plan-card-title">${plan.tier}</div>
                            <div class="plan-card-tier">${plan.category}</div>
                        </div>

                        <div class="plan-detail">
                            <span class="plan-detail-label">Plan Name:</span>
                            <span class="plan-detail-value">${plan.name}</span>
                        </div>

                        <div class="plan-detail">
                            <span class="plan-detail-label">Price:</span>
                            <span class="plan-detail-value">
                                ${plan.price}
                                ${plan.originalRate ? `<span style="text-decoration: line-through; color: #999; margin-left: 8px; font-size: 12px;">${plan.originalRate}</span>` : ''}
                                ${plan.offerPercentage ? `<span style="color: #20c5b5; margin-left: 8px; font-weight: 600; font-size: 12px;">${plan.offerPercentage}% OFF</span>` : ''}
                            </span>
                        </div>

                        <div class="plan-detail">
                            <span class="plan-detail-label">Delivery Time:</span>
                            <span class="plan-detail-value">${plan.deliveryTime}</span>
                        </div>

                        <div class="plan-detail">
                            <span class="plan-detail-label">Start Date:</span>
                            <span class="plan-detail-value">${formatDate(startDate)}</span>
                        </div>

                        <div class="plan-detail">
                            <span class="plan-detail-label">Maintenance Date:</span>
                            <span class="plan-detail-value">${formatDate(endDate)}</span>
                        </div>

                        <div class="plan-detail" style="margin-top:10px;">
                            <span class="plan-detail-label">Paid Amount:</span>
                            <span class="plan-detail-value">${paid}</span>
                        </div>
                        <div class="plan-detail">
                            <span class="plan-detail-label">Remaining Amount:</span>
                            <span class="plan-detail-value">${remaining}</span>
                        </div>

                        <div class="time-remaining">
                            <span class="time-remaining-label">Time Remaining</span>
                            <span class="time-remaining-value">${timeRemaining}</span>
                        </div>

                        <div class="plan-detail">
                            <span class="plan-detail-label">Ideal For:</span>
                            <span class="plan-detail-value">${plan.idealFor}</span>
                        </div>

                        <div class="plan-actions">
                            <button type="button" class="plan-btn plan-btn-upgrade" onclick="openUpdateRequestModal()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                üì® Request Upgrade
                            </button>
                            <button type="button" class="plan-btn plan-btn-upgrade" onclick="viewDescription()" style="background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); margin-top: 10px;">
                                üìù View Description
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Open upgrade plan modal
        function openUpgradePlanModal() {
            const modal = document.getElementById('upgrade-plan-modal');
            const combineToggle = document.getElementById('upgrade_combine_plans_toggle');
            
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            
            // Reset form
            combineToggle.checked = false;
            document.getElementById('upgrade_combined_plans_section').classList.add('hidden-section');
            document.getElementById('upgrade_single_plan_section').style.display = 'block';
            document.getElementById('upgrade_plan_count_select').value = '';
            document.getElementById('upgrade_combined_plans_dropdowns').innerHTML = '';
            
            // Pre-fill form with current user data
            if (currentUserData) {
                document.getElementById('upgrade_companyName').value = currentUserData.brandName || '';
                document.getElementById('upgrade_mobile').value = currentUserData.phone || '';
                document.getElementById('upgrade_email').value = currentUserData.email || '';
            }
            
            setTimeout(() => document.getElementById('upgrade_companyName').focus(), 50);
        }

        // Close upgrade plan modal
        function closeUpgradePlanModal() {
            const modal = document.getElementById('upgrade-plan-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            document.getElementById('upgradeModalMsg').textContent = '';
            document.getElementById('upgradePlanForm').reset();
        }

        // Open update request modal
        function openUpdateRequestModal() {
            const modal = document.getElementById('update-request-modal');
            
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            
            // Pre-fill form with current user data
            if (currentUserData) {
                document.getElementById('request_companyName').value = currentUserData.brandName || '';
                document.getElementById('request_mobile').value = currentUserData.phone || '';
                document.getElementById('request_email').value = currentUserData.email || '';
                document.getElementById('request_currentPlan').value = currentUserData.plan || '';
            }
            
            // Populate plan dropdown
            populateRequestPlanDropdown();
            
            setTimeout(() => document.getElementById('request_newPlan').focus(), 50);
        }
        
        // Populate plan dropdown for upgrade request
        function populateRequestPlanDropdown() {
            const planSelect = document.getElementById('request_newPlan');
            planSelect.innerHTML = '<option value="">-- Choose a Plan --</option>';
            
            allPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.name;
                option.textContent = `${plan.tier} - ${plan.category} (${plan.price})`;
                planSelect.appendChild(option);
            });
        }

        // Close update request modal
        function closeUpdateRequestModal() {
            const modal = document.getElementById('update-request-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            document.getElementById('updateRequestMsg').textContent = '';
            document.getElementById('updateRequestForm').reset();
        }

        // Handle combine plans toggle
        document.addEventListener('DOMContentLoaded', function() {
            loadPlansData();
            loadUserPlans();

            const combineToggle = document.getElementById('upgrade_combine_plans_toggle');
            const combinedSection = document.getElementById('upgrade_combined_plans_section');
            const singlePlanSection = document.getElementById('upgrade_single_plan_section');
            const planCountSelect = document.getElementById('upgrade_plan_count_select');
            
            if (combineToggle) {
                combineToggle.addEventListener('change', function() {
                    if (this.checked) {
                        combinedSection.classList.remove('hidden-section');
                        singlePlanSection.style.display = 'none';
                    } else {
                        combinedSection.classList.add('hidden-section');
                        singlePlanSection.style.display = 'block';
                    }
                    planCountSelect.value = '';
                    document.getElementById('upgrade_combined_plans_dropdowns').innerHTML = '';
                });
            }
            
            if (planCountSelect) {
                planCountSelect.addEventListener('change', function() {
                    const count = parseInt(this.value) || 0;
                    generateUpgradeCombinedPlanDropdowns(count);
                });
            }

            // Close modal on overlay click
            document.getElementById('upgrade-plan-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('upgrade-plan-modal')) {
                    closeUpgradePlanModal();
                }
            });

            // Close on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('upgrade-plan-modal').classList.contains('hidden')) {
                    closeUpgradePlanModal();
                }
            });

            // Form submission
            document.getElementById('upgradePlanForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const msg = document.getElementById('upgradeModalMsg');
                msg.textContent = '';
                
                const companyName = document.getElementById('upgrade_companyName').value.trim();
                const mobile = document.getElementById('upgrade_mobile').value.trim();
                const email = document.getElementById('upgrade_email').value.trim();
                const plan = document.getElementById('upgrade_plan_selection').value.trim();
                const requirements = document.getElementById('upgrade_requirements').value.trim();
                
                if (!companyName || !mobile || !email) {
                    msg.style.color = '#ffb3b3';
                    msg.textContent = 'Company Name, Mobile, and Email are required.';
                    return;
                }

                try {
                    // Update the lead record
                    const updateRes = await fetch(`/api/lead/${currentUserData.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            brandName: companyName, 
                            phone: mobile, 
                            email: email, 
                            plan: plan, 
                            requirements: requirements 
                        })
                    });

                    let data = null;
                    const ctype = (updateRes.headers.get('content-type') || '').toLowerCase();
                    if (ctype.includes('application/json')) {
                        try {
                            data = await updateRes.json();
                        } catch (parseErr) {
                            console.error('Failed to parse JSON response:', parseErr);
                        }
                    }

                    if (updateRes.ok && data && data.success) {
                        msg.style.color = '#4caf50';
                        msg.textContent = '‚úÖ Plan updated successfully!';
                        setTimeout(() => {
                            closeUpgradePlanModal();
                            // Reload plans to show updated data
                            loadUserPlans();
                        }, 1600);
                    } else {
                        msg.style.color = '#ffb3b3';
                        const serverMsg = (data && data.message) ? data.message : 'Update failed. Try again.';
                        msg.textContent = serverMsg;
                    }
                } catch (err) {
                    console.error('Plan update error:', err);
                    msg.style.color = '#ffb3b3';
                    msg.textContent = 'Network error. Make sure the server is running.';
                }
            });

            // Handle update request form submission
            document.getElementById('updateRequestForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const msg = document.getElementById('updateRequestMsg');
                msg.textContent = '';
                
                const companyName = document.getElementById('request_companyName').value.trim();
                const mobile = document.getElementById('request_mobile').value.trim();
                const email = document.getElementById('request_email').value.trim();
                const newPlan = document.getElementById('request_newPlan').value.trim();
                const description = document.getElementById('request_description').value.trim();
                const currentPlan = document.getElementById('request_currentPlan').value.trim();
                
                if (!mobile || !description) {
                    msg.style.color = '#ffb3b3';
                    msg.textContent = 'Mobile Number and Description are required.';
                    return;
                }

                try {
                    // Store the update request in leads table
                    const requestRes = await fetch('/api/lead', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            brandName: companyName, 
                            phone: mobile, 
                            email: email, 
                            plan: newPlan || currentPlan, 
                            requirements: `UPDATE REQUEST: ${description}\nCurrent Plan: ${currentPlan}\nRequested Plan: ${newPlan}`,
                            remark: 'Update Requested'
                        })
                    });

                    let data = null;
                    const ctype = (requestRes.headers.get('content-type') || '').toLowerCase();
                    if (ctype.includes('application/json')) {
                        try {
                            data = await requestRes.json();
                        } catch (parseErr) {
                            console.error('Failed to parse JSON response:', parseErr);
                        }
                    }

                    if (requestRes.ok && data && data.success) {
                        msg.style.color = '#4caf50';
                        msg.textContent = '‚úÖ Update request sent successfully! Admin will review soon.';
                        setTimeout(() => {
                            closeUpdateRequestModal();
                        }, 2000);
                    } else {
                        msg.style.color = '#ffb3b3';
                        const serverMsg = (data && data.message) ? data.message : 'Request failed. Try again.';
                        msg.textContent = serverMsg;
                    }
                } catch (err) {
                    console.error('Update request error:', err);
                    msg.style.color = '#ffb3b3';
                    msg.textContent = 'Network error. Make sure the server is running.';
                }
            });

            // Close update request modal on overlay click
            document.getElementById('update-request-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('update-request-modal')) {
                    closeUpdateRequestModal();
                }
            });

            // Close on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('update-request-modal').classList.contains('hidden')) {
                    closeUpdateRequestModal();
                }
            });
        });

        // Generate combined plan dropdowns
        function generateUpgradeCombinedPlanDropdowns(count) {
            const container = document.getElementById('upgrade_combined_plans_dropdowns');
            container.innerHTML = '';
            
            const allCategories = [...new Set(allPlans.map(p => p.category))];

            for (let i = 1; i <= count; i++) {
                const planGroup = document.createElement('div');
                planGroup.style.cssText = 'padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; border:1px solid #0a1929;';
                planGroup.innerHTML = `
                    <h4 style="color:#20c5b5; margin-top:0; margin-bottom:12px; font-size:13px;">Plan ${i}</h4>

                    <label style="display:block; color:#cfd8df; font-size:13px; font-weight:600; margin-bottom:6px;">Category</label>
                    <select id="upgrade_combined_category_${i}" style="width:100%; padding:8px 10px; margin-bottom:12px; border-radius:8px; border:1px solid #0a1929; background:#0a1929; color:#fff; font-size:13px; font-family:inherit; cursor:pointer;">
                        <option value="">-- Choose Category --</option>
                        ${allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>

                    <label style="display:block; color:#cfd8df; font-size:13px; font-weight:600; margin-bottom:6px;">Plan</label>
                    <select id="upgrade_combined_plan_${i}" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #0a1929; background:#0a1929; color:#fff; font-size:13px; font-family:inherit; cursor:pointer;">
                        <option value="">-- Choose Plan --</option>
                    </select>
                `;

                container.appendChild(planGroup);

                const categorySelect = planGroup.querySelector(`#upgrade_combined_category_${i}`);
                const planSelect = planGroup.querySelector(`#upgrade_combined_plan_${i}`);

                categorySelect.addEventListener('change', function() {
                    filterUpgradePlansByCategory(planSelect, this.value);
                    updateUpgradeCategoryDropdowns(count);
                });
            }
            
            updateUpgradeCategoryDropdowns(count);
        }

        // Filter plans by category for upgrade
        function filterUpgradePlansByCategory(selectElement, category) {
            selectElement.innerHTML = '<option value="">-- Choose Plan --</option>';
            
            if (!category) return;
            
            const categoryPlans = allPlans.filter(p => p.category === category);
            categoryPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.name;
                option.textContent = `${plan.tier} - ${plan.price}`;
                selectElement.appendChild(option);
            });
        }

        // Update category dropdowns visibility
        function updateUpgradeCategoryDropdowns(count) {
            const allCategories = [...new Set(allPlans.map(p => p.category))];
            
            for (let i = 1; i <= count; i++) {
                const categorySelect = document.getElementById(`upgrade_combined_category_${i}`);
                if (!categorySelect) continue;
                
                const selectedCategories = new Set();
                for (let j = 1; j <= count; j++) {
                    if (i !== j) {
                        const otherSelect = document.getElementById(`upgrade_combined_category_${j}`);
                        if (otherSelect && otherSelect.value) {
                            selectedCategories.add(otherSelect.value);
                        }
                    }
                }
                
                const options = categorySelect.querySelectorAll('option');
                options.forEach(option => {
                    if (option.value === '') return;
                    option.disabled = selectedCategories.has(option.value);
                });
            }
        }

        // Toggle profile dropdown menu
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const profileContainer = document.querySelector('.profile-menu-container');
            if (!profileContainer.contains(e.target)) {
                document.getElementById('profileDropdown').classList.remove('active');
            }
        });

        // Refresh plans
        function handleRefresh() {
            document.getElementById('profileDropdown').classList.remove('active');
            loadUserPlans();
        }

        // Open user profile modal
        function openUserProfile() {
            if (!currentUserData) {
                alert('User data not available');
                return;
            }

            document.getElementById('profileDropdown').classList.remove('active');

            const profileModal = `
                <div id="userProfileModal" class="modal" style="display: flex !important;">
                    <div class="modal-dialog" style="width: 500px;">
                        <button type="button" class="modal-close" onclick="closeUserProfileModal()">√ó</button>
                        <h2 class="modal-title">üë§ My Profile</h2>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <div style="width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #20c5b5 0%, #16a39e 100%); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid rgba(32, 197, 181, 0.3);">
                                ${currentUserData.profilePhoto ? `<img src="${currentUserData.profilePhoto}" style="width: 100%; height: 100%; object-fit: cover;" alt="Profile Photo" />` : `<span style="font-size: 40px;">üë§</span>`}
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <div style="background: rgba(32, 197, 181, 0.1); border: 1px solid rgba(32, 197, 181, 0.3); border-radius: 8px; padding: 20px;">
                                <div style="margin-bottom: 18px;">
                                    <label style="color: #9fbfc6; font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Company Name</label>
                                    <p style="color: #cfd8df; font-size: 15px; font-weight: 600; margin: 0;">${currentUserData.brandName || 'N/A'}</p>
                                </div>

                                <div style="margin-bottom: 18px;">
                                    <label style="color: #9fbfc6; font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Phone</label>
                                    <p style="color: #cfd8df; font-size: 15px; font-weight: 600; margin: 0;">${currentUserData.phone || 'N/A'}</p>
                                </div>

                                <div style="margin-bottom: 18px;">
                                    <label style="color: #9fbfc6; font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Email</label>
                                    <p style="color: #cfd8df; font-size: 15px; font-weight: 600; margin: 0;">${currentUserData.email || 'N/A'}</p>
                                </div>

                                <div style="margin-bottom: 18px;">
                                    <label style="color: #9fbfc6; font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Username</label>
                                    <p style="color: #cfd8df; font-size: 15px; font-weight: 600; margin: 0;">${currentUserData.username || 'Not set'}</p>
                                </div>

                                <div style="margin-bottom: 0;">
                                    <label style="color: #9fbfc6; font-size: 12px; font-weight: 600; display: block; margin-bottom: 5px;">Current Plan</label>
                                    <p style="color: #20c5b5; font-size: 15px; font-weight: 700; margin: 0;">${currentUserData.plan || 'No plan selected'}</p>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="button" onclick="openEditProfileModal()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                ‚úèÔ∏è Edit Profile
                            </button>
                            <button type="button" onclick="closeUserProfileModal()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                ‚úÖ Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const existing = document.getElementById('userProfileModal');
            if (existing) existing.remove();

            document.body.insertAdjacentHTML('beforeend', profileModal);
        }

        function closeUserProfileModal() {
            const modal = document.getElementById('userProfileModal');
            if (modal) modal.remove();
        }

        // User payments modal & helpers
        async function openUserPayments() {
            // refresh current user record from server to ensure latest payments are shown
            try {
                if (currentUserData && currentUserData.id) {
                    const resp = await fetch(`/api/lead/${encodeURIComponent(currentUserData.id)}?t=${Date.now()}`);
                    const json = await resp.json();
                    if (json && json.success) currentUserData = Object.assign({}, currentUserData || {}, json.lead);
                }
            } catch (err) {
                console.warn('Could not refresh user record before showing payments:', err);
            }

            const payments = currentUserData && Array.isArray(currentUserData.payments) ? currentUserData.payments : [];
            const total = currentUserData && currentUserData.totalAmount !== undefined ? `‚Çπ${currentUserData.totalAmount}` : '‚Äî';
            const paid = currentUserData && (currentUserData.paidAmount || 0);
            const remaining = currentUserData && (currentUserData.remainingAmount !== null && currentUserData.remainingAmount !== undefined) ? `‚Çπ${currentUserData.remainingAmount}` : '‚Äî';

            const rows = (payments.slice().reverse().map(p => {
                const d = new Date(p.date).toLocaleDateString();
                const txn = p.transactionId || p.txnId || p.id || '‚Äî';
                const thumb = p.screenshotData ? `<div style="margin-left:12px;"><img src="${p.screenshotData}" style="max-width:110px; border-radius:6px; cursor:pointer; border:1px solid rgba(255,255,255,0.04);" onclick="window.open('${p.screenshotData}','_blank')" title="Open attachment"></div>` : '';
                return `<div style="display:flex; flex-direction:column; gap:6px; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,0.03);">
                            <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
                                <div style="min-width:110px; color:#9fbfc6;">${d}</div>
                                <div style="flex:1; color:#cfd8df; display:flex; align-items:center; gap:12px;">${p.note || ''} ${thumb}</div>
                                <div style="font-weight:700; color:#20c5b5;">‚Çπ${p.amount}</div>
                                <div style="min-width:100px; text-align:right; color:#9fbfc6;">${p.method}</div>
                            </div>
                            <div style="color:#9fbfc6; font-size:12px;">Transaction: <span style="color:#cfd8df; font-weight:700;">${txn}</span></div>
                        </div>`;
            })).join('') || '<div style="color:#9fbfc6; padding:12px 0;">No payments recorded</div>';

            const modal = `
                <div id="userPaymentsModal" class="modal" style="display:flex !important;">
                    <div class="modal-dialog" style="width:520px;">
                        <button type="button" class="modal-close" onclick="closeUserPaymentsModal()">√ó</button>
                        <h2 class="modal-title">üí≥ Payment Summary</h2>
                        <div style="margin-top:12px; color:#cfd8df;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <div style="color:#9fbfc6;">Total</div>
                                <div style="font-weight:700; color:#20c5b5;">${total}</div>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <div style="color:#9fbfc6;">Paid</div>
                                <div style="font-weight:700; color:#cfd8df;">‚Çπ${paid}</div>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                                <div style="color:#9fbfc6;">Remaining</div>
                                <div style="font-weight:700; color:#f6a623;">${remaining}</div>
                            </div>
                            <div style="border-top:1px solid rgba(255,255,255,0.03); padding-top:12px; max-height:340px; overflow:auto;">${rows}</div>
                        </div>
                    </div>
                </div>
            `;

            const existing = document.getElementById('userPaymentsModal'); if (existing) existing.remove();
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        function closeUserPaymentsModal() { const m = document.getElementById('userPaymentsModal'); if (m) m.remove(); }

        // Open edit profile modal
        function openEditProfileModal() {
            const editModal = `
                <div id="editProfileModal" class="modal" style="display: flex !important;">
                    <div class="modal-dialog" style="width: 500px;">
                        <button type="button" class="modal-close" onclick="closeEditProfileModal()">√ó</button>
                        <h2 class="modal-title">‚úèÔ∏è Update Profile</h2>
                        
                        <form id="editProfileForm" style="margin-top: 20px;">
                            <div class="form-group">
                                <label for="edit_phone" class="form-label">Phone Number</label>
                                <input id="edit_phone" type="text" placeholder="+91 98765 43210" value="${currentUserData.phone || ''}" pattern="[0-9+\-() ]{6,20}" class="form-input" required />
                            </div>

                            <div class="form-group">
                                <label for="edit_email" class="form-label">Email Address</label>
                                <input id="edit_email" type="email" placeholder="you@company.com" value="${currentUserData.email || ''}" class="form-input" required />
                            </div>

                            <div id="editProfileMsg" class="form-message"></div>

                            <div style="color:#9fbfc6; font-size:13px; margin-top:12px;">üí° Payment details are managed from the <strong>Dashboard ‚Üí Payments</strong> screen and are <strong>not</strong> saved in your profile.</div>

                            <div style="display: flex; gap: 12px; margin-top: 20px;">
                                <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                    ‚úÖ Save Changes
                                </button>
                                <button type="button" onclick="closeEditProfileModal()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                    ‚ùå Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            const existing = document.getElementById('editProfileModal');
            if (existing) existing.remove();

            document.body.insertAdjacentHTML('beforeend', editModal);

            // Handle form submission
            document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitProfileUpdate();
            });
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            if (modal) modal.remove();
        }

        // Submit profile update
        async function submitProfileUpdate() {
            if (!currentUserData) {
                alert('‚ùå Error: User data not found');
                return;
            }

            const phone = document.getElementById('edit_phone').value.trim();
            const email = document.getElementById('edit_email').value.trim();
            const msgDiv = document.getElementById('editProfileMsg');

            if (!phone || !email) {
                msgDiv.style.color = '#ffb3b3';
                msgDiv.textContent = '‚ùå Phone and Email are required';
                return;
            }

            // Defensive: ensure no payment-related data gets submitted via profile update
            // (payments must always go through the Payments modal / /api/lead/:id/payment)
            const safePayload = {
                brandName: currentUserData.brandName,
                phone: phone,
                email: email,
                plan: currentUserData.plan,
                requirements: currentUserData.requirements,
                description: currentUserData.description,
                planStartDate: currentUserData.planStartDate,
                planEndDate: currentUserData.planEndDate
            };

            try {
                const response = await fetch(`/api/lead/${currentUserData.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(safePayload)
                });

                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        msgDiv.style.color = '#ffb3b3';
                        msgDiv.textContent = `‚ùå Failed: ${data.message || 'Unknown error'}`;
                    } else {
                        msgDiv.style.color = '#ffb3b3';
                        msgDiv.textContent = `‚ùå Server error: ${response.status}`;
                    }
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    msgDiv.style.color = '#4caf50';
                    msgDiv.textContent = '‚úÖ Profile updated successfully!';
                    
                    // Update currentUserData
                    currentUserData.phone = phone;
                    currentUserData.email = email;
                    
                    // Update profile info in dropdown
                    updateProfileInfo();
                    
                    setTimeout(() => {
                        closeEditProfileModal();
                        closeUserProfileModal();
                    }, 1500);
                } else {
                    msgDiv.style.color = '#ffb3b3';
                    msgDiv.textContent = `‚ùå Failed: ${data.message}`;
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                msgDiv.style.color = '#ffb3b3';
                msgDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        // Check if user is logged in
        window.addEventListener('load', () => {
            const userLoggedIn = localStorage.getItem('userLoggedIn');
            const username = localStorage.getItem('username');

            if (!userLoggedIn) {
                window.location.href = 'index.html';
                return;
            }

            if (username) {
                document.getElementById('profileUsername').textContent = username;
                // Load user data to show email in profile dropdown
                loadUserPlans();
            }
        });

        // Update profile dropdown info when user data is loaded
        function updateProfileInfo() {
            if (currentUserData) {
                document.getElementById('profileUsername').textContent = currentUserData.brandName || localStorage.getItem('username') || 'User';
                document.getElementById('profileEmail').textContent = currentUserData.email || 'user@email.com';
            }
        }

        // Handle user logout
        function handleUserLogout() {
            const confirmed = confirm('Are you sure you want to logout?');
            if (confirmed) {
                localStorage.removeItem('userLoggedIn');
                localStorage.removeItem('username');
                window.location.href = 'index.html';
            }
        }

        // View description modal
        function viewDescription() {
            if (!currentUserData || !currentUserData.description) {
                alert('No description available for this user.');
                return;
            }

            // Format description with line breaks and better styling
            const formattedDescription = currentUserData.description
                .split('\n')
                .map(line => `<p style="margin: 8px 0; line-height: 1.6;">${line || '&nbsp;'}</p>`)
                .join('');

            // Create modal dynamically
            const modalHTML = `
                <div id="descriptionViewModal" class="modal" style="display: flex !important;">
                    <div class="modal-dialog" style="width: 700px; max-width: 90vw;">
                        <button type="button" class="modal-close" onclick="closeDescriptionViewModal()">√ó</button>
                        <h2 class="modal-title">üìù Current Description</h2>
                        <div style="background: rgba(32, 197, 181, 0.1); border: 1px solid rgba(32, 197, 181, 0.3); border-radius: 8px; padding: 20px; margin-top: 15px; color: #cfd8df; line-height: 1.8;">
                            ${formattedDescription}
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="button" onclick="openDescriptionUpdateModal()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                                ‚úèÔ∏è Request Update
                            </button>
                            <button type="button" onclick="closeDescriptionViewModal()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                ‚úÖ Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existing = document.getElementById('descriptionViewModal');
            if (existing) existing.remove();

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeDescriptionViewModal() {
            const modal = document.getElementById('descriptionViewModal');
            if (modal) modal.remove();
        }

        // Open description update request modal
        function openDescriptionUpdateModal() {
            const modalHTML = `
                <div id="descriptionUpdateModal" class="modal" style="display: flex !important;">
                    <div class="modal-dialog" style="width: 700px; max-width: 90vw;">
                        <button type="button" class="modal-close" onclick="closeDescriptionUpdateModal()">√ó</button>
                        <h2 class="modal-title">üìù Request Description Update</h2>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="color: #20c5b5; margin-bottom: 10px; font-weight: 600;">Current Description:</h4>
                            <div style="background: rgba(32, 197, 181, 0.05); border: 1px solid rgba(32, 197, 181, 0.2); border-radius: 6px; padding: 12px; margin-bottom: 20px; color: #cfd8df; font-size: 13px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
                                ${currentUserData.description || 'No description available'}
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label for="updateDescRequest" style="display: block; color: #cfd8df; font-weight: 600; margin-bottom: 10px; font-size: 14px;">What changes would you like to make? *</label>
                            <textarea id="updateDescRequest" placeholder="Describe the updates you want to make to your description..." style="width: 100%; height: 150px; padding: 12px; border: 1px solid rgba(32, 197, 181, 0.3); border-radius: 6px; background: rgba(32, 197, 181, 0.05); color: #fff; font-family: inherit; font-size: 13px; resize: vertical;" required></textarea>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button type="button" onclick="submitDescriptionUpdateRequest()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                                ‚úÖ Submit Request
                            </button>
                            <button type="button" onclick="closeDescriptionUpdateModal()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existing = document.getElementById('descriptionUpdateModal');
            if (existing) existing.remove();

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeDescriptionUpdateModal() {
            const modal = document.getElementById('descriptionUpdateModal');
            if (modal) modal.remove();
        }

        // Submit description update request
        async function submitDescriptionUpdateRequest() {
            if (!currentUserData) {
                alert('‚ùå Error: User data not found');
                return;
            }

            const updateRequest = document.getElementById('updateDescRequest').value.trim();
            if (!updateRequest) {
                alert('‚ùå Please describe what changes you want to make.');
                return;
            }

            try {
                const response = await fetch(`/api/lead/${currentUserData.id}/description-update-request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        updateRequest: updateRequest,
                        currentDescription: currentUserData.description || '',
                        userId: currentUserData.id,
                        brandName: currentUserData.brandName,
                        email: currentUserData.email
                    })
                });

                // Check if response is OK first
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        alert(`‚ùå Failed to submit request: ${data.message || 'Unknown error'}`);
                    } else {
                        alert(`‚ùå Server error: ${response.status} ${response.statusText}`);
                    }
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Your update request has been submitted successfully! The admin will review it shortly.');
                    closeDescriptionUpdateModal();
                    closeDescriptionViewModal();
                } else {
                    alert(`‚ùå Failed to submit request: ${data.message}`);
                }
            } catch (error) {
                console.error('Error submitting update request:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
