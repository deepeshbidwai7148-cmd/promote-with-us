<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Promote With Us</title>
    <meta name="description" content="Admin dashboard for Promote With Us management panel">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #164069;
            --secondary: #20c5b5;
            --accent: #20c5b5;
            --light: #f8f9ff;
            --dark: #0a0e27;
            --gradient-main: linear-gradient(135deg, #164069 0%, #20c5b5 100%);
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #164069 50%, #0db8a1 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            overflow-y: hidden;
            min-height: 100vh;
            max-height: 100vh;
        }
        
        body.allow-scroll {
            overflow-y: auto;
            max-height: none;
        }
        
        .login-page { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            max-height: 100vh;
            padding: 20px; 
            position: relative; 
            z-index: 100;
            width: 100%;
        }
        
        .dashboard-page { 
            display: none; 
            padding: 20px; 
            min-height: 100vh; 
            visibility: hidden;
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        
        .login-page.active { 
            display: flex;
            visibility: visible;
            pointer-events: auto;
        }
        
        .dashboard-page.active { 
            display: block;
            visibility: visible;
            pointer-events: auto;
            position: relative;
        }
        
        .login-container {
            width: 100%;
            max-width: 420px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            animation: slideInUp 0.6s ease-out;
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .login-header h1 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: var(--primary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--secondary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(32, 197, 181, 0.1);
        }
        
        .form-group input::placeholder {
            color: #999;
        }
        
        .login-btn, .dashboard-btn {
            width: 100%;
            padding: 12px;
            background: var(--gradient-main);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .login-btn:hover, .dashboard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(32, 197, 181, 0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            min-height: 20px;
            display: none;
        }
        
        .form-message.error {
            display: block;
            background: rgba(255, 107, 107, 0.1);
            color: #e53935;
            border: 1px solid rgba(229, 57, 53, 0.3);
        }
        
        .form-message.success {
            display: block;
            background: rgba(76, 175, 80, 0.1);
            color: #388e3c;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .login-info {
            background: rgba(32, 197, 181, 0.05);
            border: 1px solid rgba(32, 197, 181, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #0f1630 0%, #14213a 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(32, 197, 181, 0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .dashboard-header h1 {
            color: #20c5b5;
            font-size: 24px;
            margin: 0;
        }
        
        .dashboard-header p {
            color: #9fbfc6;
            margin: 5px 0 0 0;
            font-size: 13px;
        }
        
        .dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            background: rgba(32, 197, 181, 0.2);
            border: 1px solid rgba(32, 197, 181, 0.5);
            color: #20c5b5;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #20c5b5;
            color: #042;
            border-color: #20c5b5;
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(32, 197, 181, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            color: #20c5b5;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            color: #cfd8df;
            font-size: 13px;
        }
        
        table thead {
            border-bottom: 1px solid rgba(32, 197, 181, 0.3);
        }
        
        table th {
            padding: 10px;
            text-align: left;
            color: #20c5b5;
            font-weight: 600;
        }
        
        table td {
            padding: 10px;
            border-bottom: 1px solid rgba(32, 197, 181, 0.1);
        }
        
        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .logout-btn {
            background: #ff6b6b !important;
            color: #fff !important;
            border-color: #ff6b6b !important;
        }
        
        .logout-btn:hover {
            background: #ff5252 !important;
        }
        
        select {
            color: #fff;
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        option {
            background: #164069;
            color: #fff;
        }
        
        .lead-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .lead-row:hover {
            background: rgba(32, 197, 181, 0.2) !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #0f1630 0%, #14213a 100%);
            border: 1px solid rgba(32, 197, 181, 0.3);
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideInUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(32, 197, 181, 0.2);
            padding-bottom: 15px;
        }
        
        .modal-header h2 {
            color: #20c5b5;
            margin: 0;
            font-size: 22px;
        }
        
        .modal-close {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            color: #ff6464;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: rgba(255, 100, 100, 0.3);
        }
        
        .modal-body {
            color: #cfd8df;
        }
        
        .detail-item {
            margin-bottom: 18px;
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
        }
        
        .detail-label {
            color: #20c5b5;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            color: #cfd8df;
            font-size: 14px;
            word-break: break-word;
            background: rgba(32, 197, 181, 0.1);
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #20c5b5;
        }
        
        /* New User-Friendly Modal Styles */
        .detail-section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(32, 197, 181, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .section-header {
            background: rgba(32, 197, 181, 0.1);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(32, 197, 181, 0.2);
        }
        
        .section-header h3 {
            color: #20c5b5;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section-content {
            padding: 20px;
        }
        
        .section-note {
            color: #9fbfc6;
            font-size: 13px;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-item.full-width {
            grid-column: 1 / -1;
        }
        
        .info-item label {
            color: #20c5b5;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-item span {
            color: #cfd8df;
            font-size: 14px;
            word-break: break-word;
        }
        
        .info-item .highlight {
            color: #fff;
            font-weight: 600;
            font-size: 15px;
        }
        
        .info-item .link {
            color: #20c5b5;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-item .link:hover {
            text-decoration: underline;
        }
        
        .status-pending {
            color: #ffc107;
            font-weight: 600;
        }
        
        .status-approved {
            color: #4caf50;
            font-weight: 600;
        }
        
        .status-rejected {
            color: #f44336;
            font-weight: 600;
        }
        
        .payment-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }
        
        .summary-item .label {
            color: #9fbfc6;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-item .value {
            color: #20c5b5;
            font-size: 16px;
            font-weight: 600;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #20c5b5, #0db8a1);
            color: #042;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(32, 197, 181, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #cfd8df;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-item.full-width {
            grid-column: 1 / -1;
        }
        
        .form-item label {
            color: #20c5b5;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-item input,
        .form-item select,
        .form-item textarea {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid rgba(32, 197, 181, 0.3);
            background: rgba(32, 197, 181, 0.1);
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .form-item input:focus,
        .form-item select:focus,
        .form-item textarea:focus {
            outline: none;
            border-color: #20c5b5;
            background: rgba(32, 197, 181, 0.15);
        }
        
        .form-item textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .credentials-section {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.3);
        }
        
        .credentials-section .section-header {
            background: rgba(76, 175, 80, 0.1);
        }
        
        .credentials-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .credential-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .credential-item label {
            color: #4caf50;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .credential-value {
            color: #4caf50;
            font-weight: 600;
            font-size: 14px;
            background: rgba(76, 175, 80, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .password-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-copy {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4caf50;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-copy:hover {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        
        .btn-generate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .credentials-form {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-success {
            flex: 1;
            background: linear-gradient(135deg, #20c5b5, #0db8a1);
            color: white;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(32, 197, 181, 0.3);
        }
        
        .btn-cancel {
            flex: 1;
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            color: #ff6464;
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-cancel:hover {
            background: rgba(255, 100, 100, 0.3);
        }
        
        .actions-section {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
            border-color: rgba(255, 193, 7, 0.3);
        }
        
        .actions-section .section-header {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.1));
            border-bottom: 2px solid rgba(255, 193, 7, 0.3);
        }
        
        .actions-section .section-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .action-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            transition: all 0.3s ease;
        }
        
        .action-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 193, 7, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.15);
        }
        
        .card-icon {
            font-size: 24px;
            background: linear-gradient(135deg, #ffc107, #ffb300);
            color: #042;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
        
        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .card-content h4 {
            color: #ffc107;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-content p {
            color: #9fbfc6;
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .status-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 12px;
        }
        
        .status-controls select {
            flex: 1;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 193, 7, 0.4);
            background: rgba(255, 193, 7, 0.1);
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .status-controls select:focus {
            outline: none;
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.15);
        }
        
        .btn-update {
            background: linear-gradient(135deg, #20c5b5, #0db8a1);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(32, 197, 181, 0.3);
        }
        
        .btn-update:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(32, 197, 181, 0.4);
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        
        .btn-approve-large,
        .btn-reject-large {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
        }
        
        .btn-approve-large {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .btn-approve-large:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .btn-reject-large {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }
        
        .btn-reject-large:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }
        
        .btn-icon {
            font-size: 16px;
        }
        
        .btn-text {
            font-size: 14px;
        }
        
        .management-actions {
            margin-top: 12px;
        }
        
        .btn-blacklist-large {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            background: linear-gradient(135deg, #b71c1c, #8b0000);
            color: white;
            box-shadow: 0 2px 8px rgba(183, 28, 28, 0.3);
        }
        
        .btn-blacklist-large:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(183, 28, 28, 0.4);
        }
        
        .blacklist-notice {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 179, 179, 0.1);
            border: 1px solid rgba(255, 179, 179, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .notice-icon {
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .notice-content {
            color: #ffb3b3;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .notice-content strong {
            color: #ff8a8a;
        }
        
        /* Payment History Styles */
        .no-payments {
            color: #9fbfc6;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
        
        .payment-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            margin-bottom: 10px;
            border: 1px solid rgba(32, 197, 181, 0.1);
        }
        
        .payment-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .payment-date {
            color: #9fbfc6;
            font-size: 12px;
            font-weight: 600;
        }
        
        .payment-details {
            color: #cfd8df;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        .payment-method {
            color: #20c5b5;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .payment-amount {
            color: #20c5b5;
            font-size: 16px;
            font-weight: 600;
            margin: 0 20px;
        }
        
        .payment-txn {
            color: #9fbfc6;
            font-size: 12px;
            min-width: 120px;
            text-align: right;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
                max-width: 95%;
            }
            
            .info-grid,
            .form-grid,
            .credentials-grid,
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-summary {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .status-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
            
            .action-card {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .card-icon {
                align-self: center;
            }
        }
        }
        
        .notification-item {
            background: rgba(32, 197, 181, 0.1);
            border: 1px solid rgba(32, 197, 181, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #20c5b5;
            transition: all 0.2s ease;
        }
        
        .notification-item:hover {
            background: rgba(32, 197, 181, 0.15);
            border-color: rgba(32, 197, 181, 0.5);
        }
        
        .notification-item.unread {
            background: rgba(32, 197, 181, 0.2);
            border-left-color: #ffc107;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .notification-type {
            display: inline-block;
            background: rgba(32, 197, 181, 0.3);
            color: #20c5b5;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .notification-type.profile-update {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        
        .notification-type.description-update {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }
        
        .notification-time {
            color: #9fbfc6;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .notification-company {
            color: #20c5b5;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .notification-details {
            color: #cfd8df;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .notification-btn {
            background: rgba(32, 197, 181, 0.2);
            border: 1px solid rgba(32, 197, 181, 0.5);
            color: #20c5b5;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            transition: all 0.2s ease;
        }
        
        .notification-btn:hover {
            background: rgba(32, 197, 181, 0.3);
        }
        
        .notification-btn.delete {
            background: rgba(255, 100, 100, 0.2);
            border-color: rgba(255, 100, 100, 0.5);
            color: #ff6464;
        }
        
        .notification-btn.delete:hover {
            background: rgba(255, 100, 100, 0.3);
        }
        
        .no-notifications {
            color: #9fbfc6;
            text-align: center;
            padding: 40px 20px;
            font-size: 14px;
        }
        
        @media (max-width: 600px) {
            .login-card {
                padding: 30px 20px;
            }
            
            .login-header h1 {
                font-size: 24px;
            }
            
            .dashboard-header {
                flex-direction: column;
                text-align: center;
            }
            
            table {
                font-size: 12px;
            }
            
            table th, table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1>üë§ Admin Login</h1>
                    <p>Enter your credentials to access the admin dashboard</p>
                </div>
                
                <form id="loginForm" autocomplete="off">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input 
                            id="username" 
                            type="text" 
                            placeholder="Enter your username" 
                            required
                            autocomplete="off"
                        />
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input 
                            id="password" 
                            type="password" 
                            placeholder="Enter your password" 
                            required
                            autocomplete="off"
                        />
                    </div>
                    
                    <button type="submit" class="login-btn" id="loginSubmitBtn">
                        Sign In
                    </button>
                    
                    <div class="form-message" id="loginMessage"></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Page -->
    <div id="dashboardPage" class="dashboard-page">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div class="dashboard-header">
                <div>
                    <h1>üìä Admin Dashboard</h1>
                    <p id="dashboardUser">Welcome, Admin</p>
                </div>
                <button id="logoutBtn" class="tab-btn logout-btn" style="margin: 0;">üö™ Logout</button>
            </div>
            
            <div class="dashboard-tabs">
                <button class="tab-btn active" onclick="switchTab('leads')">üìã All Leads</button>
                <button class="tab-btn" onclick="switchTab('pending')">‚è≥ Pending</button>
                <button class="tab-btn" onclick="switchTab('approved')">‚úÖ Approved Users</button>
                <button class="tab-btn" onclick="switchTab('blacklisted')">üö´ Blacklisted</button>
                <button class="tab-btn" onclick="switchTab('rejected')">‚ùå Rejected</button>
                <button class="tab-btn" onclick="switchTab('notifications')">üîî Notifications <span id="notificationBadge" style="display: none; background: #ff6b6b; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: inline-flex; align-items: center; justify-content: center; margin-left: 5px;">0</span></button>
                <button class="tab-btn" onclick="switchTab('plans')">‚ûï Plans</button>
            </div>
            
            <!-- Leads Tab -->
            <div id="leadsTab" class="tab-content active">
                <div class="section-box">
                    <div class="section-title">Submitted Leads</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Paid/Remaining</th>
                                    <th>Submitted At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody">
                                <tr><td colspan="6" style="text-align: center; color: #9fbfc6;">Loading leads...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Pending Tab -->
            <div id="pendingTab" class="tab-content">
                <div class="section-box">
                    <div class="section-title">Pending Leads (Awaiting Approval)</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Paid/Remaining</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTableBody">
                                <tr><td colspan="6" style="text-align: center; color: #9fbfc6;">Loading leads...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Approved Users Tab -->
            <div id="approvedTab" class="tab-content">
                <div class="section-box">
                    <div class="section-title">Approved Users & Credentials</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Email</th>
                                    <th>Paid/Remaining</th>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Status</th>
                                    <th>Approved By</th>
                                    <th>Description</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="approvedTableBody">
                                <tr><td colspan="8" style="text-align: center; color: #9fbfc6;">No approved users yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Blacklisted Tab -->
            <div id="blacklistedTab" class="tab-content">
                <div class="section-box">
                    <div class="section-title">Blacklisted Users</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Contact</th>
                                    <th>Reason</th>
                                    <th>Blacklisted At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="blacklistedTableBody">
                                <tr><td colspan="6" style="text-align: center; color: #9fbfc6;">No blacklisted users</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Rejected Tab -->
            <div id="rejectedTab" class="tab-content"> 
                <div class="section-box">
                    <div class="section-title">Rejected Leads</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Submitted At</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="rejectedTableBody">
                                <tr><td colspan="7" style="text-align: center; color: #9fbfc6;">No rejected leads</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Notifications Tab -->
            <div id="notificationsTab" class="tab-content">
                <div class="section-box">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="section-title" style="margin-bottom: 0;">User Notifications</div>
                        <button onclick="markAllNotificationsAsRead()" style="background: rgba(32,197,181,0.2); border: 1px solid rgba(32,197,181,0.5); color: #20c5b5; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">‚úì Mark All as Read</button>
                    </div>
                    <div class="scroll-container" id="notificationsContainer">
                        <p style="color: #9fbfc6; text-align: center;">Loading notifications...</p>
                    </div>
                </div>
            </div>
            
            <!-- Plans Tab -->
            <div id="plansTab" class="tab-content">
                <div class="section-box">
                    <div class="section-title">Add New Plan</div>
                    <form id="addPlanForm" style="display: grid; gap: 12px; max-height: 600px; overflow-y: auto;">
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Plan Category *</label>
                            <select id="planCategory" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); font-size: 13px; font-family: inherit; cursor: pointer;">
                                <option value="">-- Select Category --</option>
                                <option value="Website">Website</option>
                                <option value="Social Media">Social Media</option>
                                <option value="App">App</option>
                                <option value="E-commerce">E-commerce</option>
                                <option value="Digital Marketing">Digital Marketing</option>
                                <option value="Branding">Branding</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Plan Tier *</label>
                            <select id="planTier" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); font-size: 13px; font-family: inherit; cursor: pointer;">
                                <option value="">-- Select Tier --</option>
                                <option value="Silver">ü•à Silver</option>
                                <option value="Gold">ü•á Gold</option>
                                <option value="Platinum">üíé Platinum</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Plan Name *</label>
                            <input id="planName" type="text" required placeholder="e.g., Basic Website" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Price *</label>
                            <input id="planPrice" type="text" required placeholder="e.g., ‚Çπ15,000" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Original Rate (before discount)</label>
                            <input id="planOriginalRate" type="text" placeholder="e.g., ‚Çπ19,999" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Offer Percentage (discount %)</label>
                            <input id="planOfferPercentage" type="text" placeholder="e.g., 25" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Description</label>
                            <input id="planDesc" type="text" placeholder="Brief description" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Delivery Days (e.g., 5-7)</label>
                            <input id="planDeliveryTime" type="text" placeholder="e.g., 5-7 Days" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Ideal For</label>
                            <input id="planIdealFor" type="text" placeholder="e.g., Online presence & brand visibility" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Key Points / Features</label>
                            <div id="featuresContainer" style="display: grid; gap: 8px; margin-bottom: 8px;">
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" class="feature-input" placeholder="‚úÖ Feature 1" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                                    <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: none;">Remove</button>
                                </div>
                            </div>
                            <button type="button" id="addFeatureBtn" style="background: rgba(32,197,181,0.2); border: 1px solid rgba(32,197,181,0.5); color: #20c5b5; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; width: 100%;">+ Add Another Feature</button>
                        </div>
                        
                        <button type="submit" style="background: linear-gradient(135deg, #20c5b5, #0db8a1); border: none; padding: 10px; border-radius: 6px; color: #042; font-weight: 700; cursor: pointer; font-size: 14px;">Add Plan</button>
                        <div id="addPlanMsg" style="color: #ffb3b3; font-size: 12px; text-align: center; min-height: 18px;"></div>
                    </form>
                </div>
                
                <div class="section-box">
                    <div class="section-title">Added Plans</div>
                    <div class="scroll-container">
                        <div id="plansList">
                            <p style="color: #9fbfc6; text-align: center;">Loading plans...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Lead Details</h2>
                <button class="modal-close" onclick="closeDetailModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal" aria-hidden="true" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí≥ Manage Payments</h2>
                <button class="modal-close" onclick="closePaymentModal()">‚úï</button>
            </div>
            <div class="modal-body" id="paymentModalBody" style="color:#cfd8df;">
                                <div id="modalTransactionHistory" style="margin-bottom:18px;"></div>
                <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                    <label style="min-width:120px; color:#9fbfc6; font-weight:700;">Total Amount (‚Çπ)</label>
                    <input id="payment_totalAmount" type="number" min="0" step="0.01" style="flex:1; padding:8px; border-radius:6px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); color:#fff;" />
                </div>

                <h4 style="color:#20c5b5; margin-top:6px;">Add Payment</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:center; margin-bottom:12px;">
                    <div>
                        <label style="color:#9fbfc6; font-weight:700;">Amount (‚Çπ)</label>
                        <input id="payment_amount" type="number" min="0" step="0.01" style="width:100%; padding:8px; border-radius:6px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); color:#fff;" />
                    </div>
                    <div>
                        <label style="color:#9fbfc6; font-weight:700;">Method</label>
                        <select id="payment_method" style="width:100%; padding:8px; border-radius:6px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); color:#fff;">
                            <option value="Cash">Cash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="UPI">UPI</option>
                            <option value="Card">Card</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label style="color:#9fbfc6; font-weight:700;">Date</label>
                        <input id="payment_date" type="date" style="width:100%; padding:8px; border-radius:6px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); color:#fff;" />
                    </div>

                    <div>
                        <label style="color:#9fbfc6; font-weight:700;">Note (optional)</label>
                        <input id="payment_note" type="text" style="width:100%; padding:8px; border-radius:6px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); color:#fff;" />
                    </div>

                    <div style="margin-top:6px;">
                        <label style="color:#9fbfc6; font-weight:700;">Transaction ID</label>
                        <textarea id="payment_txn" placeholder="Txn id" style="width:100%; padding:8px; border-radius:6px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); color:#fff; resize:vertical; min-height:40px;"></textarea>
                    </div>

                    <div style="margin-top:6px;">
                        <label style="color:#9fbfc6; font-weight:700;">Attach screenshot</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input id="payment_screenshot" type="file" accept="image/*" style="color:#fff; background:transparent;" />
                            <button id="payment_clear_screenshot" style="background:transparent; border:1px solid rgba(255,255,255,0.04); color:#ffb3b3; padding:6px 8px; border-radius:6px; display:none;">Remove</button>
                        </div>
                        <div id="payment_screenshot_preview" style="margin-top:8px; display:none;"></div>
                    </div>
                </div>

                <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                    <button id="paymentAddBtn" onclick="submitPayment()" style="background:linear-gradient(135deg,#4caf50,#2e7d32); color:white; padding:10px 14px; border-radius:6px; border:none; font-weight:700;">Add Payment</button>
                    <button id="paymentRetryBtn" onclick="resendPendingPaymentsForLead(window.currentDetailLead && window.currentDetailLead.id)" style="display:none; margin-left:8px; background:linear-gradient(135deg,#ffd54f,#f6a623); color:#042; padding:8px 12px; border-radius:6px; border:none; font-weight:700;">Retry pending</button>
                    <div id="paymentStatus" style="color:#ffb3b3; font-weight:700;"></div>
                    <div style="margin-left:auto; text-align:right; color:#9fbfc6; font-size:13px;">
                        <div>Remaining: <span id="paymentRemaining" style="color:#f6a623; font-weight:700;">‚Äî</span></div>
                        <div style="margin-top:6px; font-size:12px; color:#9fbfc6;">Last TXN: <span id="payment_lastTxn" style="color:#cfd8df; font-weight:700;">‚Äî</span></div>
                    </div>
                </div>

                <div style="border-top:1px solid rgba(255,255,255,0.03); padding-top:12px;">
                    <h4 style="color:#20c5b5; margin-bottom:8px;">Pending Payments <small style="color:#9fbfc6; font-weight:600; font-size:12px;">(unsent)</small></h4>
                    <div id="pendingPaymentsList" style="max-height:120px; overflow:auto; margin-bottom:12px; color:#ffddcc; font-size:13px;"></div>

                    <h4 style="color:#20c5b5; margin-top:6px;">Payment History</h4>
                    <div id="paymentHistoryList" style="max-height:200px; overflow:auto; margin-top:8px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        
        function updateTxnPlaceholder() {
            const method = document.getElementById('payment_method').value;
            const txnTextarea = document.getElementById('payment_txn');
            const mandatoryMethods = ['UPI', 'Bank Transfer'];
            if (mandatoryMethods.includes(method)) {
                txnTextarea.placeholder = 'Transaction ID (required)';
            } else {
                txnTextarea.placeholder = 'Transaction ID (optional)';
            }
        }
        
        // Check if already logged in
        window.addEventListener('load', () => {
            if (sessionStorage.getItem('isAdmin') === 'true') {
                showDashboard();
            }
            // Update transaction ID placeholder based on method
            document.getElementById('payment_method').addEventListener('change', updateTxnPlaceholder);
            updateTxnPlaceholder(); // initial
        });
        
        // Admin login now authenticates with the backend (passwords are stored as bcrypt hashes server-side)
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showMessage('Please enter both username and password', 'error');
                return;
            }

            loginSubmitBtn.disabled = true;
            loginSubmitBtn.textContent = 'Signing In...';

            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json().catch(() => ({}));
                if (res.ok && data.success) {
                    // keep admin session in-session only (cleared when window/tab is closed)
                    sessionStorage.setItem('isAdmin', 'true');
                    sessionStorage.setItem('adminUsername', username.toLowerCase());
                    // store ephemeral Basic auth so the Blacklisted tab can fetch /admin/leads.json without prompting
                    try { sessionStorage.setItem('adminAuth', btoa(`${username}:${password}`)); } catch(e) { /* ignore */ }
                    document.getElementById('dashboardUser').textContent = `Welcome, ${username}`;
                    showMessage('‚úÖ Login successful!', 'success');
                    setTimeout(() => showDashboard(), 500);
                    return;
                }

                showMessage(`‚ùå ${data.message || 'Invalid username or password'}`, 'error');
                document.getElementById('password').value = '';
            } catch (err) {
                console.error('Admin login error:', err);
                showMessage('‚ùå Unable to reach server. Try again.', 'error');
            } finally {
                loginSubmitBtn.disabled = false;
                loginSubmitBtn.textContent = 'Sign In';
            }
        });
        
        function showMessage(message, type) {
            loginMessage.className = `form-message ${type}`;
            loginMessage.textContent = message;
        }
        
        function showDashboard() {
            loginPage.classList.remove('active');
            dashboardPage.classList.add('active');
            document.body.classList.add('allow-scroll');
            const username = sessionStorage.getItem('adminUsername') || 'Admin';
            document.getElementById('dashboardUser').textContent = `Welcome, ${username}`;
            loadLeads();
            loadPendingLeads();
            loadApprovedUsers();
            loadRejectedLeads();
            loadNotifications();
            loadCustomPlans();
        }
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('isAdmin');
            sessionStorage.removeItem('adminUsername');
            loginPage.classList.add('active');
            dashboardPage.classList.remove('active');
            document.body.classList.remove('allow-scroll');
            document.getElementById('loginForm').reset();
        });
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Reload data when switching to different tabs
            if (tab === 'rejected') {
                loadRejectedLeads();
            } else if (tab === 'notifications') {
                loadNotifications();
            } else if (tab === 'blacklisted') {
                loadBlacklistedUsers();
            }
        }
        
        // Load leads (excluding approved records)
        async function loadLeads() {
            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const tbody = document.getElementById('leadsTableBody');
                
                // Filter out approved leads - show only new and pending
                const filteredLeads = data.leads.filter(lead => lead.remark !== 'Approved' && lead.remark !== 'Rejected');
                
                if (filteredLeads && filteredLeads.length > 0) {
                    tbody.innerHTML = filteredLeads.map(lead => `
                        <tr class="lead-row" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">
                            <td>${lead.brandName || 'N/A'}</td>
                            <td>${lead.plan || 'Not specified'}</td>
                            <td>${lead.phone || 'N/A'}</td>
                            <td>${lead.email || 'N/A'}</td>
                            <td><span style='color:#20c5b5; font-weight:600;'>‚Çπ${lead.paidAmount || 0}</span> / <span style='color:#f6a623; font-weight:600;'>‚Çπ${lead.remainingAmount !== null && lead.remainingAmount !== undefined ? lead.remainingAmount : '‚Äî'}</span></td>
                            <td>${new Date(lead.created_at).toLocaleDateString()}</td>
                            <td style="color: #20c5b5; font-weight: 600; text-align: center;">View ‚Üí</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9fbfc6;">No new leads</td></tr>';
                }
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }
        
        // Load pending leads
        async function loadPendingLeads() {
            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const tbody = document.getElementById('pendingTableBody');
                
                // Filter only pending leads
                const pendingLeads = data.leads.filter(lead => (lead.remark || 'Pending') === 'Pending');
                
                if (pendingLeads && pendingLeads.length > 0) {
                    tbody.innerHTML = pendingLeads.map(lead => `
                        <tr class="lead-row" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">
                            <td>${lead.brandName || 'N/A'}</td>
                            <td>${lead.plan || 'Not specified'}</td>
                            <td>${lead.phone || 'N/A'}</td>
                            <td>${lead.email || 'N/A'}</td>
                            <td><span style='color:#20c5b5; font-weight:600;'>‚Çπ${lead.paidAmount || 0}</span> / <span style='color:#f6a623; font-weight:600;'>‚Çπ${lead.remainingAmount !== null && lead.remainingAmount !== undefined ? lead.remainingAmount : '‚Äî'}</span></td>
                            <td><span style="background: rgba(255, 193, 7, 0.2); color: #ffc107; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚è≥ Pending</span></td>
                            <td style="color: #20c5b5; font-weight: 600; text-align: center;">View ‚Üí</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9fbfc6;">No pending leads</td></tr>';
                }
            } catch (error) {
                console.error('Error loading pending leads:', error);
            }
        }
        
        // Load approved users
        async function loadApprovedUsers() {
            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const tbody = document.getElementById('approvedTableBody');
                
                // Filter only approved leads
                const approvedLeads = data.leads.filter(lead => lead.remark === 'Approved');
                
                if (approvedLeads && approvedLeads.length > 0) {
                    tbody.innerHTML = approvedLeads.map(lead => `
                        <tr class="lead-row">
                            <td>${lead.brandName || 'N/A'}</td>
                            <td>${lead.plan || 'Not specified'}</td>
                            <td>${lead.email || 'N/A'}</td>
                            <td><span style='color:#20c5b5; font-weight:600;'>‚Çπ${lead.paidAmount || 0}</span> / <span style='color:#f6a623; font-weight:600;'>‚Çπ${lead.remainingAmount !== null && lead.remainingAmount !== undefined ? lead.remainingAmount : '‚Äî'}</span></td>
                            <td>${lead.username || '-'}</td>
                            <td style="color: #20c5b5; font-family: monospace; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                <span>${lead.password || '-'}</span>
                                ${lead.password ? `<button style=\"background: rgba(32,197,181,0.2); border: 1px solid rgba(32,197,181,0.5); color: #20c5b5; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;\" onclick=\"event.stopPropagation(); copyToClipboard('${lead.password}', this)\">üìã Copy</button>` : ''}
                            </td>
                            <td><span style="background: rgba(76, 175, 80, 0.2); color: #4caf50; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úÖ Approved</span></td>
                            <td style="color: #cfd8df; font-size: 12px;">${lead.approvedBy || '-'}</td>
                            <td><button style="background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap;" onclick="event.stopPropagation(); openApprovedUserDescriptionModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">üìù ${lead.description ? 'Edit' : 'Add'}</button></td>
                            <td style="color: #20c5b5; font-weight: 600; text-align: center; cursor: pointer;" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">View ‚Üí</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #9fbfc6;">No approved users yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading approved users:', error);
            }
        }

        // Load blacklisted users (admin only)
        async function loadBlacklistedUsers() {
            const tbody = document.getElementById('blacklistedTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9fbfc6;">Loading blacklisted users...</td></tr>';
            try {
                // Try to reuse stored basic auth (ephemeral) set at admin login
                let auth = sessionStorage.getItem('adminAuth');
                if (!auth) {
                    const pwd = prompt('Enter admin password to view blacklisted users (this is stored only for your session):');
                    if (!pwd) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#f6a623;">Admin password required to view blacklisted users.</td></tr>';
                        return;
                    }
                    const user = sessionStorage.getItem('adminUsername') || 'admin';
                    auth = btoa(`${user}:${pwd}`);
                    sessionStorage.setItem('adminAuth', auth);
                }

                const resp = await fetch('/admin/leads.json?t=' + Date.now(), { headers: { 'Authorization': 'Basic ' + auth } });
                if (resp.status === 401) {
                    sessionStorage.removeItem('adminAuth');
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#f44336;">Unauthorized ‚Äî please re-enter admin password via the Blacklisted tab.</td></tr>';
                    return;
                }
                const data = await resp.json();
                const blacklisted = (data.leads || []).filter(l => l.blacklisted === true);
                if (!blacklisted.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9fbfc6;">No blacklisted users</td></tr>';
                    return;
                }
                tbody.innerHTML = blacklisted.map(lead => `
                    <tr class="lead-row" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">
                        <td>${lead.brandName || 'N/A'}</td>
                        <td>${lead.plan || 'Not specified'}</td>
                        <td>${lead.email || ''}${lead.phone ? ' / ' + lead.phone : ''}</td>
                        <td style="color:#ffb3b3;">${lead.blacklistReason ? escapeHtml(lead.blacklistReason) : '<em>‚Äî</em>'}</td>
                        <td>${lead.blacklistedAt ? new Date(lead.blacklistedAt).toLocaleString() : '-'}</td>
                        <td style="text-align:center"><button onclick="event.stopPropagation(); toggleBlacklist(${lead.id}, false)" style="background:linear-gradient(135deg,#4caf50,#2e7d32);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:700">üîì Unblock</button></td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Error loading blacklisted users:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#f44336;">Failed to load ‚Äî try again.</td></tr>';
            }
        }
        
        // Load rejected records
        async function loadRejectedLeads() {
            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const tbody = document.getElementById('rejectedTableBody');
                
                // Filter only rejected leads
                const rejectedLeads = data.leads.filter(lead => lead.remark === 'Rejected');
                
                if (rejectedLeads && rejectedLeads.length > 0) {
                    tbody.innerHTML = rejectedLeads.map(lead => `
                        <tr class="lead-row" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">
                            <td>${lead.brandName || 'N/A'}</td>
                            <td>${lead.plan || 'Not specified'}</td>
                            <td>${lead.phone || 'N/A'}</td>
                            <td>${lead.email || 'N/A'}</td>
                            <td>${new Date(lead.created_at).toLocaleDateString()}</td>
                            <td><span style="background: rgba(244, 67, 54, 0.2); color: #f44336; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ùå Rejected</span></td>
                            <td style="text-align: center;"><button onclick="event.stopPropagation(); deleteLead(${lead.id})" style="background: rgba(244, 67, 54, 0.2); border: 1px solid rgba(244, 67, 54, 0.5); color: #f44336; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(244, 67, 54, 0.4)'" onmouseout="this.style.background='rgba(244, 67, 54, 0.2)'">üóëÔ∏è Remove</button></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #9fbfc6;">No rejected leads</td></tr>';
                }
            } catch (error) {
                console.error('Error loading rejected leads:', error);
            }
        }
        
        // Load and display plans
        async function loadCustomPlans() {
            try {
                const response = await fetch('/api/plans');
                const data = await response.json();
                const plansContainer = document.getElementById('plansList');
                
                const groupedPlans = data.plans || {};
                let html = '';
                
                Object.entries(groupedPlans).forEach(([category, plans]) => {
                    if (plans && plans.length > 0) {
                        html += `<h3 style="color: #20c5b5; margin: 20px 0 10px 0; font-size: 14px;">${category} Plans</h3>`;
                        html += `<div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
                        
                        plans.forEach(plan => {
                            const planDataJson = JSON.stringify(plan).replace(/"/g, '&quot;');
                            const hasOffer = plan.offerPercentage && plan.originalRate;
                            html += `
                                <div style="background: rgba(32,197,181,0.1); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #20c5b5; position: relative;" data-plan-id="${plan.id}" data-plan-json="${planDataJson}">
                                    ${hasOffer ? `<div style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 11px; box-shadow: 0 2px 6px rgba(245, 87, 108, 0.3);">üéâ ${plan.offerPercentage}% OFF</div>` : ''}
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                                        <div style="flex: 1;">
                                            <strong style="color: #20c5b5;">${plan.name}</strong> - ${plan.price}
                                            ${hasOffer ? `<span style="text-decoration: line-through; color: #999; margin-left: 8px; font-size: 12px;">${plan.originalRate}</span>` : ''}<br>
                                            <span style="color: #9fbfc6; font-size: 12px;">${plan.description}</span>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="editPlanAdmin('${plan.id}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">‚úèÔ∏è Edit</button>
                                            <button onclick="deletePlanAdmin('${plan.id}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; color: white; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 87, 108, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">üóëÔ∏è Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    }
                });
                
                plansContainer.innerHTML = html || '<p style="color: #9fbfc6; text-align: center;">No plans yet</p>';
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }
        
        // Add plan form handler
        document.getElementById('addPlanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('addPlanMsg');
            msg.textContent = '';
            
            const category = document.getElementById('planCategory').value.trim();
            const tier = document.getElementById('planTier').value.trim();
            const name = document.getElementById('planName').value.trim();
            const price = document.getElementById('planPrice').value.trim();
            const originalRate = document.getElementById('planOriginalRate').value.trim();
            const offerPercentage = document.getElementById('planOfferPercentage').value.trim();
            const description = document.getElementById('planDesc').value.trim();
            const deliveryTime = document.getElementById('planDeliveryTime').value.trim();
            const idealFor = document.getElementById('planIdealFor').value.trim();
            const features = Array.from(document.querySelectorAll('.feature-input'))
                .map(input => input.value.trim())
                .filter(value => value.length > 0);
            
            if (!category || !tier || !name || !price) {
                msg.style.color = '#ffb3b3';
                msg.textContent = 'All required fields must be filled';
                return;
            }
            
            if (features.length === 0) {
                msg.style.color = '#ffb3b3';
                msg.textContent = 'Please add at least one feature';
                return;
            }
            
            try {
                const res = await fetch('/api/plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category, tier, name, price, originalRate, offerPercentage, description, features, deliveryTime, idealFor })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    msg.style.color = '#9fbfc6';
                    msg.textContent = '‚úÖ Plan added successfully!';
                    document.getElementById('addPlanForm').reset();
                    document.getElementById('featuresContainer').innerHTML = `
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="feature-input" placeholder="‚úÖ Feature 1" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                            <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: none;">Remove</button>
                        </div>
                    `;
                    setTimeout(() => loadCustomPlans(), 500);
                } else {
                    msg.style.color = '#ffb3b3';
                    msg.textContent = 'Error: ' + (data.message || 'Failed to add plan');
                }
            } catch (err) {
                console.error('Error:', err);
                msg.style.color = '#ffb3b3';
                msg.textContent = 'Network error';
            }
        });
        
        // Add feature button
        document.getElementById('addFeatureBtn').addEventListener('click', (e) => {
            e.preventDefault();
            const container = document.getElementById('featuresContainer');
            const newFeature = document.createElement('div');
            newFeature.style.display = 'flex';
            newFeature.style.gap = '8px';
            newFeature.innerHTML = `
                <input type="text" class="feature-input" placeholder="‚úÖ Feature" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">Remove</button>
            `;
            container.appendChild(newFeature);
            
            newFeature.querySelector('.remove-feature-btn').addEventListener('click', (e) => {
                e.preventDefault();
                newFeature.remove();
            });
        });
        
        // Modal functions
        function showDetailModal(lead) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');
            
            const formattedDate = new Date(lead.created_at).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${lead.email}`;
            const whatsappLink = `https://wa.me/${lead.phone}`;
            
            // Determine current remark or default to Pending
            const currentRemark = lead.remark || 'Pending';
            const showCredsButton = currentRemark === 'Approved';
            
            // Get plan start and end dates
            const planStartDate = lead.planStartDate ? new Date(lead.planStartDate).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
            const planEndDate = lead.planEndDate ? new Date(lead.planEndDate).toISOString().split('T')[0] : '';
            
            let detailsHTML = `
                <!-- User Overview Section -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>üë§ User Information</h3>
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Company Name</label>
                                <span class="highlight">${lead.brandName || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <label>Email</label>
                                <a href="${gmailLink}" target="_blank" class="link">üìß ${lead.email || 'N/A'}</a>
                            </div>
                            <div class="info-item">
                                <label>Phone</label>
                                <a href="${whatsappLink}" target="_blank" class="link">üí¨ ${lead.phone || 'N/A'}</a>
                            </div>
                            <div class="info-item">
                                <label>Selected Plan</label>
                                <span>${lead.plan || 'Not specified'}</span>
                            </div>
                            <div class="info-item full-width">
                                <label>Requirements</label>
                                <span>${lead.requirements || 'No requirements specified'}</span>
                            </div>
                            <div class="info-item">
                                <label>Submitted At</label>
                                <span>${formattedDate}</span>
                            </div>
                            <div class="info-item">
                                <label>Status</label>
                                <span class="status-${currentRemark.toLowerCase()}">${currentRemark}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>üí∞ Payment Management</h3>
                    </div>
                    <div class="section-content">
                        <div class="payment-summary">
                            <div class="summary-item">
                                <span class="label">Total Amount</span>
                                <span class="value">${lead.totalAmount !== undefined ? `‚Çπ${lead.totalAmount}` : '‚Äî'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Paid Amount</span>
                                <span class="value">‚Çπ${lead.paidAmount || 0}</span>
                            </div>
                            <div class="summary-item">
                                <span class="label">Remaining</span>
                                <span class="value">${lead.remainingAmount !== null && lead.remainingAmount !== undefined ? `‚Çπ${lead.remainingAmount}` : '‚Äî'}</span>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button type="button" onclick="openPaymentModal(${lead.id})" class="btn-primary">üí≥ Manage Payments</button>
                            <button type="button" onclick="viewPaymentHistory(${lead.id})" class="btn-secondary">üìä View History</button>
                        </div>
                    </div>
                </div>

                <!-- Plan Settings Section -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>üìÖ Plan Configuration</h3>
                    </div>
                    <div class="section-content">
                        <p class="section-note">Set plan dates ‚Äî they will take effect immediately if the lead is approved</p>
                        <div class="form-grid">
                            <div class="form-item">
                                <label>Plan Start Date</label>
                                <input id="planStartDateInput" type="date" value="${planStartDate}" />
                            </div>
                            <div class="form-item">
                                <label>Plan End Date</label>
                                <input id="planEndDateInput" type="date" value="${planEndDate}" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit User Data Section -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>‚úèÔ∏è Edit Information</h3>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-item">
                                <label>Company Name</label>
                                <input id="editBrandName" type="text" value="${lead.brandName || ''}" />
                            </div>
                            <div class="form-item">
                                <label>Phone Number</label>
                                <input id="editPhone" type="text" value="${lead.phone || ''}" />
                            </div>
                            <div class="form-item">
                                <label>Email Address</label>
                                <input id="editEmail" type="email" value="${lead.email || ''}" />
                            </div>
                            <div class="form-item">
                                <label>Selected Plan</label>
                                <select id="editPlan">
                                    <option value="">-- Choose a Plan --</option>
                                </select>
                            </div>
                            <div class="form-item full-width">
                                <label>Requirements</label>
                                <textarea id="editRequirements">${lead.requirements || ''}</textarea>
                            </div>
                        </div>
                        <button id="saveEditBtn" class="btn-save">üíæ Save Changes</button>
                    </div>
                </div>

                <!-- Credentials Section -->
                ${lead.username && lead.password ? `
                <div class="detail-section credentials-section">
                    <div class="section-header">
                        <h3>üîê Login Credentials</h3>
                    </div>
                    <div class="section-content">
                        <div class="credentials-grid">
                            <div class="credential-item">
                                <label>Username</label>
                                <span class="credential-value">${lead.username}</span>
                            </div>
                            <div class="credential-item">
                                <label>Password</label>
                                <div class="password-container">
                                    <span class="credential-value">${lead.password}</span>
                                    <button id="copyPasswordBtn" class="btn-copy">üìã Copy</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Generate Credentials Section -->
                ${showCredsButton ? `
                <div class="detail-section">
                    <div class="section-header">
                        <h3>üîë Generate Access</h3>
                    </div>
                    <div class="section-content">
                        <div id="credsButtonContainer">
                            <button id="generateCredsBtn" class="btn-generate">üîê Generate Login Credentials</button>
                        </div>
                        <div id="credsFormContainer" class="credentials-form" style="display: none;">
                            <div class="form-grid">
                                <div class="form-item">
                                    <label>üë§ Username</label>
                                    <input id="credsUsername" type="text" placeholder="Enter username" />
                                </div>
                                <div class="form-item">
                                    <label>üîí Password</label>
                                    <input id="credsPassword" type="text" placeholder="Enter password" />
                                </div>
                            </div>
                            <div class="form-actions">
                                <button id="submitCredsBtn" class="btn-success">‚úÖ Create Credentials</button>
                                <button id="cancelCredsBtn" class="btn-cancel">‚ùå Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- Actions Section -->
                <div class="detail-section actions-section">
                    <div class="section-header">
                        <h3>‚ö° Quick Actions</h3>
                    </div>
                    <div class="section-content">
                        <!-- Status Management Card -->
                        <div class="action-card">
                            <div class="card-icon">üìù</div>
                            <div class="card-content">
                                <h4>Status Management</h4>
                                <p>Update lead status and approval state</p>
                                <div class="status-controls">
                                    <select id="remarkDropdown">
                                        <option value="Pending" ${currentRemark === 'Pending' ? 'selected' : ''}>‚è≥ Pending</option>
                                        <option value="Approved" ${currentRemark === 'Approved' ? 'selected' : ''}>‚úÖ Approved</option>
                                        <option value="Rejected" ${currentRemark === 'Rejected' ? 'selected' : ''}>‚ùå Rejected</option>
                                    </select>
                                    <button id="updateRemarkBtn" class="btn-update">üíæ Update Status</button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions Card -->
                        <div class="action-card">
                            <div class="card-icon">‚ö°</div>
                            <div class="card-content">
                                <h4>Quick Actions</h4>
                                <p>Instant approve or reject decisions</p>
                                <div class="quick-actions-grid">
                                    <button onclick="event.stopPropagation(); document.getElementById('remarkDropdown').value='Approved'; updateLeadRemark(${lead.id});" class="btn-approve-large">
                                        <span class="btn-icon">‚úÖ</span>
                                        <span class="btn-text">Approve Lead</span>
                                    </button>
                                    <button onclick="event.stopPropagation(); document.getElementById('remarkDropdown').value='Rejected'; updateLeadRemark(${lead.id});" class="btn-reject-large">
                                        <span class="btn-icon">‚ùå</span>
                                        <span class="btn-text">Reject Lead</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- User Management Card -->
                        <div class="action-card">
                            <div class="card-icon">üõ°Ô∏è</div>
                            <div class="card-content">
                                <h4>User Management</h4>
                                <p>Control user access and restrictions</p>
                                <div class="management-actions">
                                    <button id="blacklistBtn" class="btn-blacklist-large">
                                        <span class="btn-icon">${lead && lead.blacklisted ? 'üîì' : 'üîí'}</span>
                                        <span class="btn-text">${lead && lead.blacklisted ? 'Remove Blacklist' : 'Blacklist User'}</span>
                                    </button>
                                    <div id="blacklistInfo" class="blacklist-notice" style="display: ${lead && lead.blacklisted ? 'block' : 'none'};">
                                        <div class="notice-icon">‚ö†Ô∏è</div>
                                        <div class="notice-content">
                                            <strong>Blacklisted</strong>
                                            ${lead && lead.blacklistReason ? '<br/>Reason: ' + escapeHtml(lead.blacklistReason) : ''}
                                            ${lead && lead.blacklistedAt ? '<br/>Since: ' + new Date(lead.blacklistedAt).toLocaleString() : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment History Section -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>üìä Payment History</h3>
                    </div>
                    <div class="section-content">
                        <div id="autoPaymentHistoryContent"></div>
                    </div>
                </div>
            `;
            

            modalBody.innerHTML = detailsHTML;
            // Render payment history for this lead
            renderPaymentHistoryForDetails(lead);
        // Render payment history for details modal (separate from payment modal)
        function renderPaymentHistoryForDetails(lead) {
            const container = document.getElementById('autoPaymentHistoryContent');
            if (!container) return;
            container.innerHTML = '';
            if (!lead || !Array.isArray(lead.payments) || lead.payments.length === 0) {
                container.innerHTML = '<div class="no-payments">No payment records found for this user.</div>';
                return;
            }
            const rows = lead.payments.slice().reverse().map(p => {
                const d = new Date(p.date).toLocaleDateString();
                const txn = p.transactionId || p.txnId || p.id || '‚Äî';
                const thumb = p.screenshotData ? `<div style="margin-left:12px;"><img src="${p.screenshotData}" style="max-width:110px; border-radius:6px; cursor:pointer; border:1px solid rgba(255,255,255,0.04);" onclick="window.open('${p.screenshotData}','_blank')" title="Open attachment"></div>` : '';
                return `\n<div class="payment-record">\n  <div class="payment-info">\n    <div class="payment-date">${d}</div>\n    <div class="payment-details">${p.note || ''} ${thumb}</div>\n    <div class="payment-method">${p.method}</div>\n  </div>\n  <div class="payment-amount">‚Çπ${p.amount}</div>\n  <div class="payment-txn">TXN: ${txn}</div>\n</div>`;
            }).join('');
            container.innerHTML = rows;
        }

            // make the currently-viewed lead available to other actions (payment modal, etc.)
            window.currentDetailLead = lead;
            window._lastOpenedLead = lead;

            // Populate plan dropdown for approved users
            if (showCredsButton) {
                populatePlanDropdownForAdmin(lead);
            }
            
            // Add event listeners
            document.getElementById('updateRemarkBtn').addEventListener('click', () => {
                updateLeadRemark(lead.id);
            });

            // Wire blacklist button (if present)
            setTimeout(() => wireBlacklistButton(), 50);
            
            // Attach Save button listener (allow editing regardless of remark)
            const saveEditBtn = document.getElementById('saveEditBtn');
            if (saveEditBtn) {
                saveEditBtn.addEventListener('click', () => {
                    saveUserDataChanges(lead);
                });
            }

            // Credentials actions remain available only for approved users
            if (showCredsButton) {
                document.getElementById('generateCredsBtn').addEventListener('click', () => {
                    showCredentialsForm(lead);
                });
                document.getElementById('submitCredsBtn').addEventListener('click', () => {
                    submitCredentials(lead);
                });
                document.getElementById('cancelCredsBtn').addEventListener('click', () => {
                    hideCredentialsForm();
                });
            }
            
            // Add event listener for password copy button in modal (if credentials exist)
            const copyPasswordBtn = document.getElementById('copyPasswordBtn');
            if (copyPasswordBtn) {
                copyPasswordBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyToClipboard(lead.password, copyPasswordBtn);
                });
            }
            
            modal.classList.add('show');
        }
        
        // Payment modal helpers (admin)
        async function openPaymentModal(leadId) {
            // leadId may be a numeric id OR a full lead object (older callers may pass object)
            let lead = null;

            if (leadId && typeof leadId === 'object') {
                lead = leadId;
            } else if (window.currentDetailLead && window.currentDetailLead.id && (!leadId || window.currentDetailLead.id === Number(leadId))) {
                lead = window.currentDetailLead;
            } else if (window._lastOpenedLead && window._lastOpenedLead.id && (!leadId || window._lastOpenedLead.id === Number(leadId))) {
                lead = window._lastOpenedLead;
            } else if (leadId) {
                // fetch the lead list and find the matching id (small, acceptable for admin panel)
                try {
                    const resp = await fetch(`/api/leads?t=${Date.now()}`);
                    const data = await resp.json();
                    lead = (data.leads || []).find(l => Number(l.id) === Number(leadId));
                } catch (err) {
                    console.error('Failed to fetch lead for payment modal', err);
                }
            }

            if (!lead) {
                alert('No lead selected ‚Äî please open the lead details first.');
                return;
            }

            // Cache the lead so submitPayment can access it
            window.currentDetailLead = lead;
            window._lastOpenedLead = lead;

            // Populate modal fields from the resolved lead
            document.getElementById('payment_totalAmount').value = lead && lead.totalAmount !== undefined ? lead.totalAmount : '';
            document.getElementById('payment_amount').value = '';
            document.getElementById('payment_method').value = 'Cash';
            document.getElementById('payment_date').value = new Date().toISOString().split('T')[0];
            document.getElementById('payment_note').value = '';
            document.getElementById('paymentStatus').textContent = '';
            renderPaymentHistory(lead || {});
            // Also render transaction history at the top of the modal
            renderTransactionHistoryInModal(lead || {});
                    // Render transaction history at the top of the payment modal
                    function renderTransactionHistoryInModal(lead) {
                        const container = document.getElementById('modalTransactionHistory');
                        if (!container) return;
                        container.innerHTML = '<h4 style="color:#20c5b5; margin-bottom:8px;">Transaction History</h4>';
                        if (!lead || !Array.isArray(lead.payments) || lead.payments.length === 0) {
                            container.innerHTML += '<div style="color:#9fbfc6;">No transactions recorded</div>';
                            return;
                        }
                        const rows = lead.payments.slice().reverse().map(p => {
                            const d = new Date(p.date).toLocaleDateString();
                            const txn = p.transactionId || p.txnId || p.id || '‚Äî';
                            const thumb = p.screenshotData ? `<div style=\"margin-left:12px;\"><img src=\"${p.screenshotData}\" style=\"max-width:110px; border-radius:6px; cursor:pointer; border:1px solid rgba(255,255,255,0.04);\" onclick=\"window.open('${p.screenshotData}','_blank')\" title=\"Open attachment\"></div>` : '';
                            return `\n<div style=\"padding:10px; border-radius:6px; background:rgba(255,255,255,0.02); margin-bottom:8px;\">\n  <div style=\"display:flex; justify-content:space-between; gap:12px; align-items:center;\">\n    <div style=\"min-width:120px; color:#9fbfc6;\">${d}<div style=\\\"color:#9fbfc6; font-size:11px; margin-top:6px;\\\">TXN: <span style=\\\"color:#cfd8df; font-weight:700;\\\">${txn}</span></div></div>\n    <div style=\"flex:1; color:#cfd8df; display:flex; gap:12px; align-items:center;\">${p.note || ''} ${thumb}</div>\n    <div style=\"font-weight:700; color:#20c5b5;\">‚Çπ${p.amount}</div>\n    <div style=\"min-width:110px; text-align:right; color:#9fbfc6;\">${p.method}</div>\n  </div>\n</div>`;
                        }).join('');
                        container.innerHTML += rows;
                    }
            // show any locally pending (unsent) payments for this lead
            renderPendingPayments(lead.id);
            const modal = document.getElementById('paymentModal');
            modal.style.display = 'flex';
            modal.classList.add('show');
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) { modal.classList.remove('show'); modal.style.display = 'none'; }
        }

        async function submitPayment() {
            const lead = window.currentDetailLead || window._lastOpenedLead;
            if (!lead || !lead.id) return alert('No lead selected');
            const total = document.getElementById('payment_totalAmount').value;
            const amount = document.getElementById('payment_amount').value;
            const method = document.getElementById('payment_method').value;
            const date = document.getElementById('payment_date').value;
            const note = document.getElementById('payment_note').value;
            const txn = document.getElementById('payment_txn').value.trim();

            // Validation: Transaction ID is mandatory for UPI and Bank Transfer
            const mandatoryMethods = ['UPI', 'Bank Transfer'];
            if (mandatoryMethods.includes(method) && !txn) {
                alert(`Transaction ID is required for ${method}`);
                return;
            }

            const payload = {};
            if (total !== '') payload.totalAmount = total;
            const parsedAmount = (amount === '' || amount === null) ? '' : Number(amount);
            if (parsedAmount !== '') {
                payload.payment = { amount: parsedAmount, method, date, note };
                if (txn) payload.payment.transactionId = txn;
            }

            // helper to persist unsent payment locally so user doesn't lose data
            function savePending(paymentPayload) {
                try {
                    const all = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
                    const item = Object.assign({ id: 'p_' + Date.now(), leadId: lead.id, createdAt: new Date().toISOString() }, paymentPayload);
                    all.push(item);
                    localStorage.setItem('pendingPayments', JSON.stringify(all));
                    return item;
                } catch (e) { console.warn('Could not save pending payment', e); return null; }
            }

            try {
                const res = await fetch(`/api/lead/${lead.id}/payment`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    // prefer server-provided addedPayment for the created txn
                    const added = data.addedPayment || ((data.lead && data.lead.payments) ? data.lead.payments.slice(-1)[0] : null);

                    // refresh the authoritative lead from server
                    const refreshed = await refreshCurrentLead(lead.id) || data.lead;
                    if (refreshed) {
                        window.currentDetailLead = refreshed;
                        renderPaymentHistory(refreshed);
                    }

                    const txn = (added && (added.transactionId || added.txnId || added.id)) ? (added.transactionId || added.txnId || added.id) : (refreshed && refreshed.payments && refreshed.payments.slice(-1)[0] ? (refreshed.payments.slice(-1)[0].transactionId || refreshed.payments.slice(-1)[0].txnId || refreshed.payments.slice(-1)[0].id) : '‚Äî');
                    document.getElementById('payment_lastTxn').textContent = txn;
                    document.getElementById('paymentRemaining').textContent = data.lead && data.lead.remainingAmount !== null && data.lead.remainingAmount !== undefined ? `‚Çπ${data.lead.remainingAmount}` : '‚Äî';

                    document.getElementById('paymentStatus').style.color = '#4caf50';
                    document.getElementById('paymentStatus').textContent = `Saved ‚Ä¢ ${txn}`;

                    // clear any pending item that matches this payload (best-effort)
                    try {
                        const pending = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
                        const remaining = pending.filter(p => !(p.leadId === lead.id && p.payment && p.payment.amount === payload.payment?.amount && p.payment?.method === payload.payment?.method && Math.abs(new Date(p.createdAt) - Date.now()) < 1000 * 60 * 5));
                        localStorage.setItem('pendingPayments', JSON.stringify(remaining));
                    } catch (e) { /* ignore */ }

                    // refresh lists
                    loadLeads();
                    renderPendingPayments(lead.id);
                } else {
                    document.getElementById('paymentStatus').style.color = '#ffb3b3';
                    document.getElementById('paymentStatus').textContent = data.message || 'Save failed';
                }
            } catch (err) {
                console.error('Payment save error:', err);
                document.getElementById('paymentStatus').style.color = '#ffb3b3';
                document.getElementById('paymentStatus').textContent = 'Network error ‚Äî saved locally';

                // persist the unsent payment locally and show to user for retry
                const pendingItem = savePending({ payment: payload.payment || null, totalAmount: payload.totalAmount });
                renderPendingPayments(lead.id);
                if (pendingItem) {
                    // keep the modal open and inform the user
                    const btn = document.getElementById('paymentRetryBtn');
                    if (btn) btn.style.display = 'inline-block';
                }
            }
        }

        function renderPaymentHistory(lead) {
            const container = document.getElementById('paymentHistoryList');
            if (!container) return;
            container.innerHTML = '';
            if (!lead || !Array.isArray(lead.payments) || lead.payments.length === 0) {
                container.innerHTML = '<div style="color:#9fbfc6;">No payments recorded</div>';
                document.getElementById('paymentRemaining').textContent = lead && lead.remainingAmount !== undefined && lead.remainingAmount !== null ? `‚Çπ${lead.remainingAmount}` : '‚Äî';
                document.getElementById('payment_lastTxn').textContent = '‚Äî';
                return;
            }

            // Update remaining amount display
            document.getElementById('paymentRemaining').textContent = lead.remainingAmount !== undefined && lead.remainingAmount !== null ? `‚Çπ${lead.remainingAmount}` : '‚Äî';

            const rows = lead.payments.slice().reverse().map(p => {
                const d = new Date(p.date).toLocaleDateString();
                const txn = p.transactionId || p.txnId || p.id || '‚Äî';
                const thumb = p.screenshotData ? `<div style="margin-left:12px;"><img src="${p.screenshotData}" style="max-width:110px; border-radius:6px; cursor:pointer; border:1px solid rgba(255,255,255,0.04);" onclick="window.open('${p.screenshotData}','_blank')" title="Open attachment"></div>` : '';
                return `\n<div style="padding:10px; border-radius:6px; background:rgba(255,255,255,0.02); margin-bottom:8px;">\n  <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">\n    <div style="min-width:120px; color:#9fbfc6;">${d}<div style=\"color:#9fbfc6; font-size:11px; margin-top:6px;\">TXN: <span style=\"color:#cfd8df; font-weight:700;\">${txn}</span></div></div>\n    <div style="flex:1; color:#cfd8df; display:flex; gap:12px; align-items:center;">${p.note || ''} ${thumb}</div>\n    <div style="font-weight:700; color:#20c5b5;">‚Çπ${p.amount}</div>\n    <div style="min-width:110px; text-align:right; color:#9fbfc6;">${p.method}</div>\n  </div>\n</div>`;
            }).join('');
            container.innerHTML = rows;

            // Populate last TXN
            const newest = (lead.payments || []).slice(-1)[0];
            document.getElementById('payment_lastTxn').textContent = newest ? (newest.transactionId || newest.txnId || newest.id) : '‚Äî';
        }

        /* Pending-payments (offline/unsent) helpers ------------------------------------------------- */
        function getPendingPayments() {
            try { return JSON.parse(localStorage.getItem('pendingPayments') || '[]'); }
            catch (e) { return []; }
        }

        function getPendingForLead(leadId) {
            return getPendingPayments().filter(p => String(p.leadId) === String(leadId));
        }

        function renderPendingPayments(leadId) {
            const container = document.getElementById('pendingPaymentsList');
            if (!container) return;
            const items = getPendingForLead(leadId || (window.currentDetailLead && window.currentDetailLead.id));
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="color:#9fbfc6;">No pending payments</div>';
                const btn = document.getElementById('paymentRetryBtn'); if (btn) btn.style.display = 'none';
                return;
            }

            const rows = items.slice().reverse().map(p => {
                const d = new Date(p.createdAt).toLocaleString();
                const amt = p.payment ? `‚Çπ${p.payment.amount}` : (p.totalAmount ? `Total set: ‚Çπ${p.totalAmount}` : '‚Äî');
                const method = p.payment ? (p.payment.method || '‚Äî') : '‚Äî';
                return `
  <div style="padding:8px; border-radius:6px; background:rgba(255,120,80,0.04); margin-bottom:8px; display:flex; justify-content:space-between; gap:12px; align-items:center;">
    <div style="color:#ffddcc; font-size:13px;"><div style="font-weight:700; color:#ffd6b2;">${amt}</div><div style="font-size:12px; color:#9fbfc6; margin-top:6px;">${d} ‚Ä¢ ${method}</div></div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button data-pid="${p.id}" class="tiny-btn retry-pending" style="background:#20c5b5; color:#042; border-radius:6px; padding:6px 8px; border:none; font-weight:700;">Retry</button>
      <button data-pid="${p.id}" class="tiny-btn remove-pending" style="background:transparent; color:#ffb3b3; border:1px solid rgba(255,255,255,0.03); border-radius:6px; padding:6px 8px;">Remove</button>
    </div>
  </div>`;
            }).join('');

            container.innerHTML = rows;
            // wire up retry/remove handlers
            Array.from(container.querySelectorAll('.retry-pending')).forEach(b => b.addEventListener('click', e => retryPendingPayment(e.target.getAttribute('data-pid'))));
            Array.from(container.querySelectorAll('.remove-pending')).forEach(b => b.addEventListener('click', e => removePendingPayment(e.target.getAttribute('data-pid'))));
            const btn = document.getElementById('paymentRetryBtn'); if (btn) btn.style.display = 'inline-block';
        }

        async function retryPendingPayment(pendingId) {
            const all = getPendingPayments();
            const item = all.find(x => x.id === pendingId);
            if (!item) return renderPendingPayments(item && item.leadId);
            try {
                const payload = {};
                if (item.totalAmount) payload.totalAmount = item.totalAmount;
                if (item.payment) payload.payment = item.payment;
                const resp = await fetch(`/api/lead/${item.leadId}/payment`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    // remove the pending item
                    const remaining = all.filter(x => x.id !== pendingId);
                    localStorage.setItem('pendingPayments', JSON.stringify(remaining));
                    await refreshCurrentLead(item.leadId);
                    renderPaymentHistory(window.currentDetailLead || {});
                    renderPendingPayments(item.leadId);
                    loadLeads();
                    return;
                } else {
                    alert('Retry failed: ' + (data && data.message ? data.message : 'server rejected'));
                }
            } catch (err) {
                console.error('retryPendingPayment error', err);
                alert('Network error while retrying pending payment. Will keep it saved locally.');
            }
        }

        function removePendingPayment(pendingId) {
            const all = getPendingPayments();
            const remaining = all.filter(x => x.id !== pendingId);
            localStorage.setItem('pendingPayments', JSON.stringify(remaining));
            renderPendingPayments(window.currentDetailLead && window.currentDetailLead.id);
        }

        // attempt to resend all pending payments for the currently-open lead (best-effort)
        async function resendPendingPaymentsForLead(leadId) {
            const items = getPendingForLead(leadId || (window.currentDetailLead && window.currentDetailLead.id));
            for (const it of items) {
                try { await retryPendingPayment(it.id); } catch (e) { /* continue */ }
            }
        }

        /* ------------------------------------------------------------------------------------------- */

        // Refresh a single lead from server and update cached objects
        async function refreshCurrentLead(leadId) {
            try {
                const resp = await fetch(`/api/lead/${encodeURIComponent(leadId)}?t=${Date.now()}`);
                const data = await resp.json();
                const l = data && data.success ? data.lead : null;
                if (l) {
                    window.currentDetailLead = l;
                    window._lastOpenedLead = l;
                }
                return l || null;
            } catch (err) {
                console.error('refreshCurrentLead error:', err);
                return null;
            }
        }

        function viewPaymentHistory(leadId) { openPaymentModal(leadId); }

        // Function to save user data changes
        async function saveUserDataChanges(lead) {
            const brandName = document.getElementById('editBrandName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const planStartDate = document.getElementById('planStartDateInput').value;
            const planEndDate = document.getElementById('planEndDateInput').value;
            
            if (!brandName || !phone || !email) {
                alert('‚ùå Company Name, Phone, and Email are required');
                return;
            }
            
            // Allow saving when dates are not being changed; if one date is provided require the other
            if ((planStartDate && !planEndDate) || (!planStartDate && planEndDate)) {
                alert('‚ùå Please provide both Plan Start Date and Maintenance Date, or clear both to remove dates.');
                return;
            }
            
            try {
                const response = await fetch(`/api/lead/${lead.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        brandName, 
                        phone, 
                        email, 
                        plan, 
                        requirements,
                        planStartDate,
                        planEndDate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ User data updated successfully!');
                    closeDetailModal();
                    loadLeads();
                    loadPendingLeads();
                    loadApprovedUsers();
                    loadRejectedLeads();
                } else {
                    alert(`‚ùå Failed to update user data: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating user data:', error);
                alert(`‚ùå Error updating user data: ${error.message}`);
            }
        }
        
        // Function to show credentials form
        function showCredentialsForm(lead) {
            document.getElementById('credsButtonContainer').style.display = 'none';
            document.getElementById('credsFormContainer').style.display = 'block';
            document.getElementById('credsUsername').focus();
        }
        
        // Function to hide credentials form
        function hideCredentialsForm() {
            document.getElementById('credsButtonContainer').style.display = 'block';
            document.getElementById('credsFormContainer').style.display = 'none';
            document.getElementById('credsUsername').value = '';
            document.getElementById('credsPassword').value = '';
        }
        
        // Function to submit custom credentials
        async function submitCredentials(lead) {
            const username = document.getElementById('credsUsername').value.trim();
            const password = document.getElementById('credsPassword').value.trim();
            
            if (!username || !password) {
                alert('‚ùå Please enter both username and password');
                return;
            }
            
            if (username.length < 3) {
                alert('‚ùå Username must be at least 3 characters long');
                return;
            }
            
            if (password.length < 6) {
                alert('‚ùå Password must be at least 6 characters long');
                return;
            }
            
            try {
                const response = await fetch(`/api/lead/${lead.id}/credentials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, email: lead.email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Credentials Created!\n\nUsername: ${username}\nPassword: ${password}\n\nPlease share these with the client.`);
                    hideCredentialsForm();
                    loadApprovedUsers();
                    loadLeads();
                } else {
                    alert(`‚ùå Failed to create credentials: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error creating credentials:', error);
                alert(`‚ùå Error creating credentials: ${error.message}`);
            }
        }
        
        // Function to update lead remark
        async function updateLeadRemark(leadId) {
            const remark = document.getElementById('remarkDropdown').value;
            const adminUsername = sessionStorage.getItem('adminUsername') || 'Admin';
            
            console.log('Updating remark for lead:', leadId, 'to:', remark);
            
            try {
                const response = await fetch(`/api/lead/${leadId}/remark`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ remark, approvedBy: adminUsername })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    alert(`‚úÖ Lead marked as ${remark}`);
                    
                    // Close modal and reload
                    closeDetailModal();
                    loadLeads();
                    loadPendingLeads();
                    loadApprovedUsers();
                    loadRejectedLeads();
                } else {
                    alert(`‚ùå Failed to update remark: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating remark:', error);
                alert(`‚ùå Error updating remark: ${error.message}`);
            }
        }
        
        // Toggle blacklist status for a lead (admin)
        async function toggleBlacklist(leadId, setTo, reason) {
            try {
                const resp = await fetch(`/api/lead/${leadId}/blacklist`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ blacklisted: !!setTo, reason: reason || '' })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    alert(data.blacklisted ? 'üîí User blacklisted' : '‚úÖ User removed from blacklist');
                    closeDetailModal();
                    loadLeads();
                    loadPendingLeads();
                    loadApprovedUsers();
                    loadRejectedLeads();
                    // refresh the blacklisted tab (if open)
                    try { if (document.getElementById('blacklistedTab').classList.contains('active')) loadBlacklistedUsers(); } catch(e){}
                    return;
                }
                alert('Failed to update blacklist: ' + (data.message || 'server error'));
            } catch (err) {
                console.error('toggleBlacklist error', err);
                alert('Network error while updating blacklist');
            }
        }

        // Wire blacklist button in detail modal (safe to call even if element missing)
        function wireBlacklistButton() {
            const btn = document.getElementById('blacklistBtn');
            if (!btn) return;
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const lead = window.currentDetailLead || window._lastOpenedLead;
                if (!lead || !lead.id) return alert('No lead selected');
                const willBlacklist = !lead.blacklisted;
                if (!willBlacklist) {
                    if (!confirm('Remove user from blacklist?')) return;
                    toggleBlacklist(lead.id, false);
                    return;
                }

                const reason = prompt('Reason for blacklisting (optional):');
                if (!confirm(willBlacklist ? 'Are you sure you want to blacklist this user? This will block future submissions and access.' : 'Confirm change?')) return;
                toggleBlacklist(lead.id, true, reason || '');
            });
        }

        // Function to delete a rejected lead
        async function deleteLead(leadId) {
            if (!confirm('Are you sure you want to permanently delete this record?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/lead/${leadId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Lead deleted successfully');
                    loadRejectedLeads();
                } else {
                    alert(`‚ùå Failed to delete lead: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert(`‚ùå Error deleting lead: ${error.message}`);
            }
        }
        
        // Populate plan dropdown in admin edit panel
        async function populatePlanDropdownForAdmin(lead) {
            try {
                const response = await fetch(`/api/plans?t=${Date.now()}`);
                const data = await response.json();
                const plans = data.allPlans || data.plans || [];
                
                const planSelect = document.getElementById('editPlan');
                if (!planSelect) return;
                
                // Clear existing options except the first one
                planSelect.innerHTML = '<option value="">-- Choose a Plan --</option>';
                
                // Add all plans to dropdown
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.name;
                    option.textContent = `${plan.tier} - ${plan.category} (${plan.price})`;
                    planSelect.appendChild(option);
                });
                
                // Set current plan as selected
                if (lead.plan) {
                    planSelect.value = lead.plan;
                }
            } catch (error) {
                console.error('Error loading plans for dropdown:', error);
            }
        }
        
        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.remove('show');
        }
        // Function to copy text to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerText;
                button.innerText = '‚úÖ Copied!';
                button.style.background = 'rgba(76, 175, 80, 0.3)';
                button.style.borderColor = 'rgba(76, 175, 80, 0.7)';
                button.style.color = '#4caf50';
                
                setTimeout(() => {
                    button.innerText = originalText;
                    button.style.background = 'rgba(32,197,181,0.2)';
                    button.style.borderColor = 'rgba(32,197,181,0.5)';
                    button.style.color = '#20c5b5';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err.message);
            });
        }
        
        // Current lead for description modal in approved tab
        let currentLeadForApprovedDesc = null;

        // Function to open description modal for approved users
        function openApprovedUserDescriptionModal(lead) {
            currentLeadForApprovedDesc = lead;
            const modal = document.getElementById('approvedUserDescModal');
            const descTitle = modal.querySelector('.modal-header h2');
            const descHistory = document.getElementById('descriptionHistory');
            document.getElementById('approvedDescTextarea').value = lead.description || '';
            
            // Show current description in history section
            if (lead.description) {
                descHistory.innerHTML = lead.description;
            } else {
                descHistory.innerHTML = '<em style="color: #9fbfc6;">No description added yet</em>';
            }
            
            // Display update requests if any
            const updateRequestsContainer = document.getElementById('descriptionUpdateRequests');
            if (lead.descriptionUpdateRequests && lead.descriptionUpdateRequests.length > 0) {
                const pendingRequests = lead.descriptionUpdateRequests.filter(r => r.status === 'Pending');
                if (pendingRequests.length > 0) {
                    const requestsHTML = pendingRequests.map(req => `
                        <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                            <p style="color: #ff9800; font-weight: 600; font-size: 12px; margin: 0 0 8px 0;">üîî User Update Request - ${new Date(req.timestamp).toLocaleDateString()}</p>
                            <p style="color: #cfd8df; font-size: 13px; margin: 0; white-space: pre-wrap; word-wrap: break-word;">${req.updateRequest}</p>
                            <button onclick="markUpdateRequestAsResolved('${req.id}')" style="margin-top: 8px; padding: 4px 10px; background: rgba(76, 175, 80, 0.3); border: 1px solid rgba(76, 175, 80, 0.5); color: #4caf50; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px;">‚úÖ Resolved</button>
                        </div>
                    `).join('');
                    updateRequestsContainer.innerHTML = `<p style="color: #ff9800; font-weight: 600; font-size: 13px; margin-bottom: 10px;">üì¢ Pending User Requests:</p>${requestsHTML}`;
                    updateRequestsContainer.style.display = 'block';
                } else {
                    updateRequestsContainer.style.display = 'none';
                }
            } else {
                updateRequestsContainer.style.display = 'none';
            }
            
            // Change title and button based on whether description exists
            if (lead.description) {
                descTitle.textContent = 'üìù Update Description';
                document.getElementById('saveApprovedDescBtn').textContent = '‚úÖ Update Description';
            } else {
                descTitle.textContent = 'üìù Add Description';
                document.getElementById('saveApprovedDescBtn').textContent = '‚úÖ Add Description';
            }
            
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
        }

        // Function to close description modal for approved users
        function closeApprovedUserDescriptionModal() {
            const modal = document.getElementById('approvedUserDescModal');
            modal.style.display = 'none';
            modal.classList.add('hidden');
            currentLeadForApprovedDesc = null;
            document.getElementById('approvedDescTextarea').value = '';
        }

        // Function to mark update request as resolved
        async function markUpdateRequestAsResolved(requestId) {
            if (!currentLeadForApprovedDesc) {
                alert('‚ùå Error: Lead not found');
                return;
            }

            try {
                const response = await fetch(`/api/lead/${currentLeadForApprovedDesc.id}/description-update-request/${requestId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'Resolved' })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Update request marked as resolved');
                    loadApprovedUsers();
                    openApprovedUserDescriptionModal(currentLeadForApprovedDesc);
                } else {
                    alert(`‚ùå Failed: ${data.message}`);
                }
            } catch (error) {
                console.error('Error marking request as resolved:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }        // Function to save description for approved user
        async function saveApprovedUserDescription() {
            if (!currentLeadForApprovedDesc) {
                alert('‚ùå Error: Lead not found');
                return;
            }

            const description = document.getElementById('approvedDescTextarea').value.trim();
            
            try {
                const response = await fetch(`/api/lead/${currentLeadForApprovedDesc.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        brandName: currentLeadForApprovedDesc.brandName,
                        phone: currentLeadForApprovedDesc.phone,
                        email: currentLeadForApprovedDesc.email,
                        plan: currentLeadForApprovedDesc.plan,
                        requirements: currentLeadForApprovedDesc.requirements,
                        description: description,
                        planStartDate: currentLeadForApprovedDesc.planStartDate,
                        planEndDate: currentLeadForApprovedDesc.planEndDate
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Description saved successfully!');
                    // Update the local object
                    currentLeadForApprovedDesc.description = description;
                    closeApprovedUserDescriptionModal();
                    // Reload approved users to update the table
                    loadApprovedUsers();
                } else {
                    alert(`‚ùå Failed to save description: ${data.message}`);
                }
            } catch (error) {
                console.error('Error saving description:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        // Close modal when clicking outside the content
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') {
                closeDetailModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetailModal();
            }
        });

        // Edit Plan Function
        async function editPlanAdmin(planId) {
            // Get the plan element and retrieve data from the data attribute
            const planElement = document.querySelector(`[data-plan-id="${planId}"]`);
            if (!planElement) {
                console.error('Plan element not found');
                alert('Error: Plan not found');
                return;
            }

            const planDataJson = planElement.getAttribute('data-plan-json');
            let planData = null;
            
            try {
                planData = JSON.parse(planDataJson);
            } catch (e) {
                console.error('Error parsing plan data:', e);
                alert('Error loading plan data');
                return;
            }
            
            // Populate form fields with existing plan data
            document.getElementById('planCategory').value = planData.category || '';
            document.getElementById('planTier').value = planData.tier || '';
            document.getElementById('planName').value = planData.name || '';
            document.getElementById('planPrice').value = planData.price || '';
            document.getElementById('planOriginalRate').value = planData.originalRate || '';
            document.getElementById('planOfferPercentage').value = planData.offerPercentage || '';
            document.getElementById('planDesc').value = planData.description || '';
            document.getElementById('planDeliveryTime').value = planData.deliveryTime || '';
            document.getElementById('planIdealFor').value = planData.idealFor || '';
            
            // Populate features
            const featuresContainer = document.getElementById('featuresContainer');
            featuresContainer.innerHTML = '';
            const features = planData.features || [];
            
            features.forEach((feature, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; gap: 8px;';
                div.innerHTML = `
                    <input type="text" class="feature-input" value="${feature.replace(/"/g, '&quot;')}" placeholder="‚úÖ Feature" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                    <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; ${features.length > 1 ? '' : 'display: none;'}">Remove</button>
                `;
                const removeBtn = div.querySelector('.remove-feature-btn');
                removeBtn.onclick = function() {
                    div.remove();
                };
                featuresContainer.appendChild(div);
            });
            
            // Add empty feature slot
            const emptyDiv = document.createElement('div');
            emptyDiv.style.cssText = 'display: flex; gap: 8px;';
            emptyDiv.innerHTML = `
                <input type="text" class="feature-input" placeholder="‚úÖ Feature" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: none;">Remove</button>
            `;
            const removeBtn = emptyDiv.querySelector('.remove-feature-btn');
            removeBtn.onclick = function() {
                emptyDiv.remove();
            };
            featuresContainer.appendChild(emptyDiv);
            
            // Store planId for update
            document.getElementById('addPlanForm').dataset.planId = planId;
            document.getElementById('addPlanForm').dataset.planEditMode = 'true';
            
            // Change button text and styling to "Update Plan"
            const submitBtn = document.querySelector('#addPlanForm button[type="submit"]');
            submitBtn.textContent = '‚úÖ Update Plan';
            submitBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            
            // Add visual highlight to form
            const form = document.getElementById('addPlanForm');
            form.style.border = '2px solid #667eea';
            form.style.borderRadius = '8px';
            form.style.padding = '15px';
            form.style.background = 'rgba(102, 126, 234, 0.05)';
            
            // Scroll to form
            document.getElementById('plansTab').scrollIntoView({ behavior: 'smooth' });
            
            // Show notification
            const msg = document.getElementById('addPlanMsg');
            msg.style.color = '#667eea';
            msg.textContent = '‚úèÔ∏è Edit mode: Make your changes and click "Update Plan"';
            setTimeout(() => {
                msg.textContent = '';
            }, 3000);
        }

        // Delete Plan Function
        async function deletePlanAdmin(planId) {
            if (!confirm('Are you sure you want to delete this plan? This action cannot be undone.')) {
                return;
            }
            
            try {
                const res = await fetch(`/api/plans/${planId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    alert('‚úÖ Plan deleted successfully!');
                    loadCustomPlans();
                } else {
                    alert('‚ùå Error deleting plan: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting plan:', error);
                alert('‚ùå Error deleting plan: ' + error.message);
            }
        }

        // Modify form submission to handle both add and update
        const addPlanForm = document.getElementById('addPlanForm');
        if (addPlanForm) {
            addPlanForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('addPlanMsg');
            msg.textContent = '';
            
            const category = document.getElementById('planCategory').value.trim();
            const tier = document.getElementById('planTier').value.trim();
            const name = document.getElementById('planName').value.trim();
            const price = document.getElementById('planPrice').value.trim();
            const originalRate = document.getElementById('planOriginalRate').value.trim();
            const offerPercentage = document.getElementById('planOfferPercentage').value.trim();
            const description = document.getElementById('planDesc').value.trim();
            const deliveryTime = document.getElementById('planDeliveryTime').value.trim();
            const idealFor = document.getElementById('planIdealFor').value.trim();
            const features = Array.from(document.querySelectorAll('.feature-input'))
                .map(input => input.value.trim())
                .filter(value => value.length > 0);
            
            if (!category || !tier || !name || !price) {
                msg.style.color = '#ffb3b3';
                msg.textContent = 'All required fields must be filled';
                return;
            }
            
            if (features.length === 0) {
                msg.style.color = '#ffb3b3';
                msg.textContent = 'Please add at least one feature';
                return;
            }
            
            try {
                const planId = parseInt(document.getElementById('addPlanForm').dataset.planId) || null;
                const method = planId ? 'PUT' : 'POST';
                const url = planId ? `/api/plans/${planId}` : '/api/plans';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category, tier, name, price, originalRate, offerPercentage, description, features, deliveryTime, idealFor })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    msg.style.color = '#9fbfc6';
                    msg.textContent = planId ? '‚úÖ Plan updated successfully!' : '‚úÖ Plan added successfully!';
                    document.getElementById('addPlanForm').reset();
                    delete document.getElementById('addPlanForm').dataset.planId;
                    delete document.getElementById('addPlanForm').dataset.planEditMode;
                    
                    // Reset form styling
                    const form = document.getElementById('addPlanForm');
                    form.style.border = 'none';
                    form.style.background = 'transparent';
                    form.style.padding = '0';
                    
                    const submitBtn = document.querySelector('#addPlanForm button[type="submit"]');
                    submitBtn.textContent = 'Add Plan';
                    submitBtn.style.background = 'linear-gradient(135deg, #20c5b5, #0db8a1)';
                    
                    document.getElementById('featuresContainer').innerHTML = `
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="feature-input" placeholder="‚úÖ Feature 1" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                            <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: none;">Remove</button>
                        </div>
                    `;
                    setTimeout(() => loadCustomPlans(), 500);
                } else {
                    msg.style.color = '#ffb3b3';
                    msg.textContent = '‚ùå ' + (data.message || 'Error saving plan');
                }
            } catch (error) {
                msg.style.color = '#ffb3b3';
                msg.textContent = '‚ùå Error: ' + error.message;
            }
            });
        }
    </script>

    <!-- Approved User Description Modal -->
    <div id="approvedUserDescModal" class="modal" style="background: rgba(0, 0, 0, 0.95);">
        <div class="modal-content" style="max-width: 95%; width: 95%; max-height: 95vh; height: 95vh; display: flex; flex-direction: column; padding: 0;">
            <div class="modal-header" style="padding: 25px 30px; flex-shrink: 0;">
                <h2 style="font-size: 28px;">üìù Add Description</h2>
                <button type="button" class="modal-close" onclick="closeApprovedUserDescriptionModal()">√ó</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column;">
                <div id="descriptionUpdateRequests" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 6px; max-height: 200px; overflow-y: auto;">
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(32, 197, 181, 0.1); border: 1px solid rgba(32, 197, 181, 0.3); border-radius: 6px;">
                    <p style="color: #20c5b5; font-weight: 600; font-size: 13px; margin: 0 0 8px 0;">Current Description History:</p>
                    <div id="descriptionHistory" style="color: #cfd8df; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; min-height: 40px;">
                        <em style="color: #9fbfc6;">No description added yet</em>
                    </div>
                </div>
                <label style="display: block; color: #20c5b5; font-weight: 600; font-size: 14px; margin-bottom: 15px;">Write or update description for this user:</label>
                <textarea id="approvedDescTextarea" style="padding: 15px; border-radius: 8px; border: 2px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.05); color: #fff; font-size: 15px; font-family: 'Inter', sans-serif; width: 100%; flex: 1; resize: none; line-height: 1.6;" placeholder="Enter detailed description..."></textarea>
                <div style="display: flex; gap: 15px; margin-top: 20px; flex-shrink: 0;">
                    <button id="saveApprovedDescBtn" style="flex: 1; background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); border: none; color: white; padding: 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">‚úÖ Add Description</button>
                    <button type="button" onclick="closeApprovedUserDescriptionModal()" style="flex: 1; background: rgba(255,100,100,0.2); border: 2px solid rgba(255,100,100,0.5); color: #ff6464; padding: 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">‚ùå Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add event listener for approved user description save button
        document.getElementById('saveApprovedDescBtn').addEventListener('click', () => {
            saveApprovedUserDescription();
        });
        
        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch(`/api/notifications?t=${Date.now()}`);
                const data = await response.json();
                const container = document.getElementById('notificationsContainer');
                const badge = document.getElementById('notificationBadge');
                
                if (!data.notifications || data.notifications.length === 0) {
                    container.innerHTML = '<div class="no-notifications">No notifications yet. Profile updates and description changes will appear here.</div>';
                    badge.style.display = 'none';
                    return;
                }
                
                // Update badge with unread count
                if (data.unreadCount > 0) {
                    badge.textContent = data.unreadCount;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
                
                container.innerHTML = data.notifications.map(notification => {
                    const date = new Date(notification.createdAt);
                    const formattedTime = date.toLocaleString();
                    const typeLabel = notification.type === 'profile_update' ? 'Profile Update' : 'Description Update';
                    const typeClass = notification.type === 'profile_update' ? 'profile-update' : 'description-update';
                    const isUnread = !notification.read;
                    
                    let details = '';
                    if (notification.type === 'profile_update' && notification.details.changes) {
                        details = notification.details.changes.map(change => `‚Ä¢ ${change}`).join('<br>');
                    } else if (notification.type === 'description_update') {
                        details = `<strong>Requested Changes:</strong><br>${notification.details.updateRequest}`;
                    }
                    
                    return `
                        <div class="notification-item ${isUnread ? 'unread' : ''}">
                            <div class="notification-header">
                                <div>
                                    <span class="notification-type ${typeClass}">${typeLabel}</span>
                                    <div class="notification-company">üë§ ${notification.brandName || 'Unknown User'}</div>
                                    <div class="notification-time">üìß ${notification.email || 'N/A'} ‚Ä¢ üïê ${formattedTime}</div>
                                </div>
                            </div>
                            <div class="notification-details">${details}</div>
                            <div class="notification-actions">
                                ${isUnread ? `<button class="notification-btn" onclick="markNotificationAsRead(${notification.id})">‚úì Mark as Read</button>` : '<span style="color: #9fbfc6; font-size: 12px;">‚úì Read</span>'}
                                <button class="notification-btn delete" onclick="deleteNotification(${notification.id})">üóë Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('notificationsContainer').innerHTML = '<div class="no-notifications">‚ùå Error loading notifications</div>';
            }
        }
        
        // Mark single notification as read
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'PATCH'
                });
                
                if (response.ok) {
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                alert('‚ùå Error marking notification as read');
            }
        }
        
        // Mark all notifications as read
        async function markAllNotificationsAsRead() {
            try {
                const response = await fetch('/api/notifications/read-all', {
                    method: 'PATCH'
                });
                
                if (response.ok) {
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                alert('‚ùå Error marking all notifications as read');
            }
        }
        
        // Delete notification
        async function deleteNotification(notificationId) {
            if (!confirm('Are you sure you want to delete this notification?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/notifications/${notificationId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                alert('‚ùå Error deleting notification');
            }
        }
    </script>
</body>
</html>
