<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Promote With Us</title>
    <meta name="description" content="Admin dashboard for Promote With Us management panel">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #164069;
            --secondary: #20c5b5;
            --accent: #20c5b5;
            --light: #f8f9ff;
            --dark: #0a0e27;
            --gradient-main: linear-gradient(135deg, #164069 0%, #20c5b5 100%);
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #164069 50%, #0db8a1 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            overflow-y: hidden;
            min-height: 100vh;
            max-height: 100vh;
        }
        
        body.allow-scroll {
            overflow-y: auto;
            max-height: none;
        }
        
        .login-page { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            max-height: 100vh;
            padding: 20px; 
            position: relative; 
            z-index: 100;
            width: 100%;
        }
        
        .dashboard-page { 
            display: none; 
            padding: 20px; 
            min-height: 100vh; 
            visibility: hidden;
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        
        .login-page.active { 
            display: flex;
            visibility: visible;
            pointer-events: auto;
        }
        
        .dashboard-page.active { 
            display: block;
            visibility: visible;
            pointer-events: auto;
            position: relative;
        }
        
        .login-container {
            width: 100%;
            max-width: 420px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            animation: slideInUp 0.6s ease-out;
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .login-header h1 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: var(--primary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--secondary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(32, 197, 181, 0.1);
        }
        
        .form-group input::placeholder {
            color: #999;
        }
        
        .login-btn, .dashboard-btn {
            width: 100%;
            padding: 12px;
            background: var(--gradient-main);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .login-btn:hover, .dashboard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(32, 197, 181, 0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            min-height: 20px;
            display: none;
        }
        
        .form-message.error {
            display: block;
            background: rgba(255, 107, 107, 0.1);
            color: #e53935;
            border: 1px solid rgba(229, 57, 53, 0.3);
        }
        
        .form-message.success {
            display: block;
            background: rgba(76, 175, 80, 0.1);
            color: #388e3c;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .login-info {
            background: rgba(32, 197, 181, 0.05);
            border: 1px solid rgba(32, 197, 181, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #0f1630 0%, #14213a 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(32, 197, 181, 0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .dashboard-header h1 {
            color: #20c5b5;
            font-size: 24px;
            margin: 0;
        }
        
        .dashboard-header p {
            color: #9fbfc6;
            margin: 5px 0 0 0;
            font-size: 13px;
        }
        
        .dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            background: rgba(32, 197, 181, 0.2);
            border: 1px solid rgba(32, 197, 181, 0.5);
            color: #20c5b5;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #20c5b5;
            color: #042;
            border-color: #20c5b5;
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(32, 197, 181, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            color: #20c5b5;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            color: #cfd8df;
            font-size: 13px;
        }
        
        table thead {
            border-bottom: 1px solid rgba(32, 197, 181, 0.3);
        }
        
        table th {
            padding: 10px;
            text-align: left;
            color: #20c5b5;
            font-weight: 600;
        }
        
        table td {
            padding: 10px;
            border-bottom: 1px solid rgba(32, 197, 181, 0.1);
        }
        
        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .logout-btn {
            background: #ff6b6b !important;
            color: #fff !important;
            border-color: #ff6b6b !important;
        }
        
        .logout-btn:hover {
            background: #ff5252 !important;
        }
        
        select {
            color: #fff;
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        option {
            background: #164069;
            color: #fff;
        }
        
        .lead-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .lead-row:hover {
            background: rgba(32, 197, 181, 0.2) !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #0f1630 0%, #14213a 100%);
            border: 1px solid rgba(32, 197, 181, 0.3);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideInUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(32, 197, 181, 0.2);
            padding-bottom: 15px;
        }
        
        .modal-header h2 {
            color: #20c5b5;
            margin: 0;
            font-size: 22px;
        }
        
        .modal-close {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            color: #ff6464;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: rgba(255, 100, 100, 0.3);
        }
        
        .modal-body {
            color: #cfd8df;
        }
        
        .detail-item {
            margin-bottom: 18px;
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
        }
        
        .detail-label {
            color: #20c5b5;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            color: #cfd8df;
            font-size: 14px;
            word-break: break-word;
            background: rgba(32, 197, 181, 0.1);
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #20c5b5;
        }
        
        @media (max-width: 600px) {
            .login-card {
                padding: 30px 20px;
            }
            
            .login-header h1 {
                font-size: 24px;
            }
            
            .dashboard-header {
                flex-direction: column;
                text-align: center;
            }
            
            table {
                font-size: 12px;
            }
            
            table th, table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1>üë§ Admin Login</h1>
                    <p>Enter your credentials to access the admin dashboard</p>
                </div>
                
                <form id="loginForm" autocomplete="off">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input 
                            id="username" 
                            type="text" 
                            placeholder="Enter your username" 
                            required
                            autocomplete="off"
                        />
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input 
                            id="password" 
                            type="password" 
                            placeholder="Enter your password" 
                            required
                            autocomplete="off"
                        />
                    </div>
                    
                    <button type="submit" class="login-btn" id="loginSubmitBtn">
                        Sign In
                    </button>
                    
                    <div class="form-message" id="loginMessage"></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Page -->
    <div id="dashboardPage" class="dashboard-page">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div class="dashboard-header">
                <div>
                    <h1>üìä Admin Dashboard</h1>
                    <p id="dashboardUser">Welcome, Admin</p>
                </div>
                <button id="logoutBtn" class="tab-btn logout-btn" style="margin: 0;">üö™ Logout</button>
            </div>
            
            <div class="dashboard-tabs">
                <button class="tab-btn active" onclick="switchTab('leads')">üìã All Leads</button>
                <button class="tab-btn" onclick="switchTab('pending')">‚è≥ Pending</button>
                <button class="tab-btn" onclick="switchTab('approved')">‚úÖ Approved Users</button>
                <button class="tab-btn" onclick="switchTab('rejected')">‚ùå Rejected</button>
                <button class="tab-btn" onclick="switchTab('plans')">‚ûï Plans</button>
            </div>
            
            <!-- Leads Tab -->
            <div id="leadsTab" class="tab-content active">
                <div class="section-box">
                    <div class="section-title">Submitted Leads</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Submitted At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody">
                                <tr><td colspan="6" style="text-align: center; color: #9fbfc6;">Loading leads...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Pending Tab -->
            <div id="pendingTab" class="tab-content">
                <div class="section-box">
                    <div class="section-title">Pending Leads (Awaiting Approval)</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTableBody">
                                <tr><td colspan="6" style="text-align: center; color: #9fbfc6;">Loading leads...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Approved Users Tab -->
            <div id="approvedTab" class="tab-content">
                <div class="section-box">
                    <div class="section-title">Approved Users & Credentials</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Email</th>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Status</th>
                                    <th>Approved By</th>
                                    <th>Description</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="approvedTableBody">
                                <tr><td colspan="8" style="text-align: center; color: #9fbfc6;">No approved users yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Rejected Tab -->
            <div id="rejectedTab" class="tab-content">
                <div class="section-box">
                    <div class="section-title">Rejected Leads</div>
                    <div class="scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Plan</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Submitted At</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="rejectedTableBody">
                                <tr><td colspan="7" style="text-align: center; color: #9fbfc6;">No rejected leads</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Plans Tab -->
            <div id="plansTab" class="tab-content">
                <div class="section-box">
                    <div class="section-title">Add New Plan</div>
                    <form id="addPlanForm" style="display: grid; gap: 12px; max-height: 600px; overflow-y: auto;">
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Plan Category *</label>
                            <select id="planCategory" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); font-size: 13px; font-family: inherit; cursor: pointer;">
                                <option value="">-- Select Category --</option>
                                <option value="Website">Website</option>
                                <option value="Social Media">Social Media</option>
                                <option value="App">App</option>
                                <option value="E-commerce">E-commerce</option>
                                <option value="Digital Marketing">Digital Marketing</option>
                                <option value="Branding">Branding</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Plan Tier *</label>
                            <select id="planTier" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); font-size: 13px; font-family: inherit; cursor: pointer;">
                                <option value="">-- Select Tier --</option>
                                <option value="Silver">ü•à Silver</option>
                                <option value="Gold">ü•á Gold</option>
                                <option value="Platinum">üíé Platinum</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Plan Name *</label>
                            <input id="planName" type="text" required placeholder="e.g., Basic Website" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Price *</label>
                            <input id="planPrice" type="text" required placeholder="e.g., ‚Çπ15,000" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Original Rate (before discount)</label>
                            <input id="planOriginalRate" type="text" placeholder="e.g., ‚Çπ19,999" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Offer Percentage (discount %)</label>
                            <input id="planOfferPercentage" type="text" placeholder="e.g., 25" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Description</label>
                            <input id="planDesc" type="text" placeholder="Brief description" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Delivery Days (e.g., 5-7)</label>
                            <input id="planDeliveryTime" type="text" placeholder="e.g., 5-7 Days" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Ideal For</label>
                            <input id="planIdealFor" type="text" placeholder="e.g., Online presence & brand visibility" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                        </div>
                        
                        <div>
                            <label style="display: block; color: #cfd8df; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Key Points / Features</label>
                            <div id="featuresContainer" style="display: grid; gap: 8px; margin-bottom: 8px;">
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" class="feature-input" placeholder="‚úÖ Feature 1" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                                    <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: none;">Remove</button>
                                </div>
                            </div>
                            <button type="button" id="addFeatureBtn" style="background: rgba(32,197,181,0.2); border: 1px solid rgba(32,197,181,0.5); color: #20c5b5; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; width: 100%;">+ Add Another Feature</button>
                        </div>
                        
                        <button type="submit" style="background: linear-gradient(135deg, #20c5b5, #0db8a1); border: none; padding: 10px; border-radius: 6px; color: #042; font-weight: 700; cursor: pointer; font-size: 14px;">Add Plan</button>
                        <div id="addPlanMsg" style="color: #ffb3b3; font-size: 12px; text-align: center; min-height: 18px;"></div>
                    </form>
                </div>
                
                <div class="section-box">
                    <div class="section-title">Added Plans</div>
                    <div class="scroll-container">
                        <div id="plansList">
                            <p style="color: #9fbfc6; text-align: center;">Loading plans...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Lead Details</h2>
                <button class="modal-close" onclick="closeDetailModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Details will be populated here -->
            </div>
        </div>
    </div>
    
    <script>
        // Valid credentials
        const validCredentials = {
            'deepesh': 'ACDS@123',
            'chetan': 'ACDS@123',
            'sameer': 'ACDS@123',
            'aarshin': 'ACDS@123',
            'jayesh': 'ACDS@123'
        };
        
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        
        // Check if already logged in
        window.addEventListener('load', () => {
            if (localStorage.getItem('isAdmin') === 'true') {
                showDashboard();
            }
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showMessage('Please enter both username and password', 'error');
                return;
            }
            
            // Validate credentials
            if (validCredentials[username] && validCredentials[username] === password) {
                loginSubmitBtn.disabled = true;
                loginSubmitBtn.textContent = 'Signing In...';
                
                localStorage.setItem('isAdmin', 'true');
                localStorage.setItem('adminUsername', username);
                document.getElementById('dashboardUser').textContent = `Welcome, ${username}`;
                showMessage('‚úÖ Login successful!', 'success');
                setTimeout(() => showDashboard(), 500);
            } else {
                showMessage('‚ùå Invalid username or password', 'error');
                document.getElementById('password').value = '';
            }
        });
        
        function showMessage(message, type) {
            loginMessage.className = `form-message ${type}`;
            loginMessage.textContent = message;
        }
        
        function showDashboard() {
            loginPage.classList.remove('active');
            dashboardPage.classList.add('active');
            document.body.classList.add('allow-scroll');
            const username = localStorage.getItem('adminUsername') || 'Admin';
            document.getElementById('dashboardUser').textContent = `Welcome, ${username}`;
            loadLeads();
            loadPendingLeads();
            loadApprovedUsers();
            loadRejectedLeads();
            loadCustomPlans();
        }
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('adminUsername');
            loginPage.classList.add('active');
            dashboardPage.classList.remove('active');
            document.body.classList.remove('allow-scroll');
            document.getElementById('loginForm').reset();
        });
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Reload data when switching to rejected tab
            if (tab === 'rejected') {
                loadRejectedLeads();
            }
        }
        
        // Load leads (excluding approved records)
        async function loadLeads() {
            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const tbody = document.getElementById('leadsTableBody');
                
                // Filter out approved leads - show only new and pending
                const filteredLeads = data.leads.filter(lead => lead.remark !== 'Approved' && lead.remark !== 'Rejected');
                
                if (filteredLeads && filteredLeads.length > 0) {
                    tbody.innerHTML = filteredLeads.map(lead => `
                        <tr class="lead-row" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">
                            <td>${lead.brandName || 'N/A'}</td>
                            <td>${lead.plan || 'Not specified'}</td>
                            <td>${lead.phone || 'N/A'}</td>
                            <td>${lead.email || 'N/A'}</td>
                            <td>${new Date(lead.created_at).toLocaleDateString()}</td>
                            <td style="color: #20c5b5; font-weight: 600; text-align: center;">View ‚Üí</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9fbfc6;">No new leads</td></tr>';
                }
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }
        
        // Load pending leads
        async function loadPendingLeads() {
            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const tbody = document.getElementById('pendingTableBody');
                
                // Filter only pending leads
                const pendingLeads = data.leads.filter(lead => (lead.remark || 'Pending') === 'Pending');
                
                if (pendingLeads && pendingLeads.length > 0) {
                    tbody.innerHTML = pendingLeads.map(lead => `
                        <tr class="lead-row" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">
                            <td>${lead.brandName || 'N/A'}</td>
                            <td>${lead.plan || 'Not specified'}</td>
                            <td>${lead.phone || 'N/A'}</td>
                            <td>${lead.email || 'N/A'}</td>
                            <td><span style="background: rgba(255, 193, 7, 0.2); color: #ffc107; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚è≥ Pending</span></td>
                            <td style="color: #20c5b5; font-weight: 600; text-align: center;">View ‚Üí</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9fbfc6;">No pending leads</td></tr>';
                }
            } catch (error) {
                console.error('Error loading pending leads:', error);
            }
        }
        
        // Load approved users
        async function loadApprovedUsers() {
            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const tbody = document.getElementById('approvedTableBody');
                
                // Filter only approved leads
                const approvedLeads = data.leads.filter(lead => lead.remark === 'Approved');
                
                if (approvedLeads && approvedLeads.length > 0) {
                    tbody.innerHTML = approvedLeads.map(lead => `
                        <tr class="lead-row">
                            <td>${lead.brandName || 'N/A'}</td>
                            <td>${lead.plan || 'Not specified'}</td>
                            <td>${lead.email || 'N/A'}</td>
                            <td>${lead.username || '-'}</td>
                            <td style="color: #20c5b5; font-family: monospace; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                <span>${lead.password || '-'}</span>
                                ${lead.password ? `<button style="background: rgba(32,197,181,0.2); border: 1px solid rgba(32,197,181,0.5); color: #20c5b5; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;" onclick="event.stopPropagation(); copyToClipboard('${lead.password}', this)">üìã Copy</button>` : ''}
                            </td>
                            <td><span style="background: rgba(76, 175, 80, 0.2); color: #4caf50; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úÖ Approved</span></td>
                            <td style="color: #cfd8df; font-size: 12px;">${lead.approvedBy || '-'}</td>
                            <td><button style="background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap;" onclick="event.stopPropagation(); openApprovedUserDescriptionModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">üìù ${lead.description ? 'Edit' : 'Add'}</button></td>
                            <td style="color: #20c5b5; font-weight: 600; text-align: center; cursor: pointer;" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">View ‚Üí</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #9fbfc6;">No approved users yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading approved users:', error);
            }
        }
        
        // Load rejected records
        async function loadRejectedLeads() {
            try {
                const response = await fetch(`/api/leads?t=${Date.now()}`);
                const data = await response.json();
                const tbody = document.getElementById('rejectedTableBody');
                
                // Filter only rejected leads
                const rejectedLeads = data.leads.filter(lead => lead.remark === 'Rejected');
                
                if (rejectedLeads && rejectedLeads.length > 0) {
                    tbody.innerHTML = rejectedLeads.map(lead => `
                        <tr class="lead-row" onclick="showDetailModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})">
                            <td>${lead.brandName || 'N/A'}</td>
                            <td>${lead.plan || 'Not specified'}</td>
                            <td>${lead.phone || 'N/A'}</td>
                            <td>${lead.email || 'N/A'}</td>
                            <td>${new Date(lead.created_at).toLocaleDateString()}</td>
                            <td><span style="background: rgba(244, 67, 54, 0.2); color: #f44336; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ùå Rejected</span></td>
                            <td style="text-align: center;"><button onclick="event.stopPropagation(); deleteLead(${lead.id})" style="background: rgba(244, 67, 54, 0.2); border: 1px solid rgba(244, 67, 54, 0.5); color: #f44336; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(244, 67, 54, 0.4)'" onmouseout="this.style.background='rgba(244, 67, 54, 0.2)'">üóëÔ∏è Remove</button></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #9fbfc6;">No rejected leads</td></tr>';
                }
            } catch (error) {
                console.error('Error loading rejected leads:', error);
            }
        }
        
        // Load and display plans
        async function loadCustomPlans() {
            try {
                const response = await fetch('/api/plans');
                const data = await response.json();
                const plansContainer = document.getElementById('plansList');
                
                const groupedPlans = data.plans || {};
                let html = '';
                
                Object.entries(groupedPlans).forEach(([category, plans]) => {
                    if (plans && plans.length > 0) {
                        html += `<h3 style="color: #20c5b5; margin: 20px 0 10px 0; font-size: 14px;">${category} Plans</h3>`;
                        html += `<div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;
                        
                        plans.forEach(plan => {
                            const planDataJson = JSON.stringify(plan).replace(/"/g, '&quot;');
                            html += `
                                <div style="background: rgba(32,197,181,0.1); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #20c5b5;" data-plan-id="${plan.id}" data-plan-json="${planDataJson}">
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                                        <div style="flex: 1;">
                                            <strong style="color: #20c5b5;">${plan.name}</strong> - ${plan.price}<br>
                                            <span style="color: #9fbfc6; font-size: 12px;">${plan.description}</span>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="editPlanAdmin('${plan.id}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">‚úèÔ∏è Edit</button>
                                            <button onclick="deletePlanAdmin('${plan.id}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; color: white; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; white-space: nowrap; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 87, 108, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">üóëÔ∏è Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    }
                });
                
                plansContainer.innerHTML = html || '<p style="color: #9fbfc6; text-align: center;">No plans yet</p>';
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }
        
        // Add plan form handler
        document.getElementById('addPlanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('addPlanMsg');
            msg.textContent = '';
            
            const category = document.getElementById('planCategory').value.trim();
            const tier = document.getElementById('planTier').value.trim();
            const name = document.getElementById('planName').value.trim();
            const price = document.getElementById('planPrice').value.trim();
            const originalRate = document.getElementById('planOriginalRate').value.trim();
            const offerPercentage = document.getElementById('planOfferPercentage').value.trim();
            const description = document.getElementById('planDesc').value.trim();
            const deliveryTime = document.getElementById('planDeliveryTime').value.trim();
            const idealFor = document.getElementById('planIdealFor').value.trim();
            const features = Array.from(document.querySelectorAll('.feature-input'))
                .map(input => input.value.trim())
                .filter(value => value.length > 0);
            
            if (!category || !tier || !name || !price) {
                msg.style.color = '#ffb3b3';
                msg.textContent = 'All required fields must be filled';
                return;
            }
            
            if (features.length === 0) {
                msg.style.color = '#ffb3b3';
                msg.textContent = 'Please add at least one feature';
                return;
            }
            
            try {
                const res = await fetch('/api/plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category, tier, name, price, originalRate, offerPercentage, description, features, deliveryTime, idealFor })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    msg.style.color = '#9fbfc6';
                    msg.textContent = '‚úÖ Plan added successfully!';
                    document.getElementById('addPlanForm').reset();
                    document.getElementById('featuresContainer').innerHTML = `
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="feature-input" placeholder="‚úÖ Feature 1" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                            <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: none;">Remove</button>
                        </div>
                    `;
                    setTimeout(() => loadCustomPlans(), 500);
                } else {
                    msg.style.color = '#ffb3b3';
                    msg.textContent = 'Error: ' + (data.message || 'Failed to add plan');
                }
            } catch (err) {
                console.error('Error:', err);
                msg.style.color = '#ffb3b3';
                msg.textContent = 'Network error';
            }
        });
        
        // Add feature button
        document.getElementById('addFeatureBtn').addEventListener('click', (e) => {
            e.preventDefault();
            const container = document.getElementById('featuresContainer');
            const newFeature = document.createElement('div');
            newFeature.style.display = 'flex';
            newFeature.style.gap = '8px';
            newFeature.innerHTML = `
                <input type="text" class="feature-input" placeholder="‚úÖ Feature" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">Remove</button>
            `;
            container.appendChild(newFeature);
            
            newFeature.querySelector('.remove-feature-btn').addEventListener('click', (e) => {
                e.preventDefault();
                newFeature.remove();
            });
        });
        
        // Modal functions
        function showDetailModal(lead) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');
            
            const formattedDate = new Date(lead.created_at).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${lead.email}`;
            const whatsappLink = `https://wa.me/${lead.phone}`;
            
            // Determine current remark or default to Pending
            const currentRemark = lead.remark || 'Pending';
            const showCredsButton = currentRemark === 'Approved';
            
            // Get plan start and end dates
            const planStartDate = lead.planStartDate ? new Date(lead.planStartDate).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
            const planEndDate = lead.planEndDate ? new Date(lead.planEndDate).toISOString().split('T')[0] : '';
            
            let detailsHTML = `
                <div class="detail-item">
                    <div class="detail-label">Company Name</div>
                    <div class="detail-value" style="border-left: 3px solid #20c5b5; font-weight: 600; font-size: 15px;">${lead.brandName || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value"><a href="${gmailLink}" target="_blank" style="color: #20c5b5; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">üìß ${lead.email || 'N/A'}</a></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone</div>
                    <div class="detail-value"><a href="${whatsappLink}" target="_blank" style="color: #20c5b5; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">üí¨ ${lead.phone || 'N/A'}</a></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Selected Plan</div>
                    <div class="detail-value">${lead.plan || 'Not specified'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Requirements</div>
                    <div class="detail-value">${lead.requirements || 'No requirements specified'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Submitted At</div>
                    <div class="detail-value">${formattedDate}</div>
                </div>
                
                <div style="border-top: 1px solid rgba(32,197,181,0.2); padding-top: 20px; margin-top: 20px;">
                    <div class="detail-item">
                        <div class="detail-label">Remark / Status</div>
                        <select id="remarkDropdown" style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #20c5b5; font-size: 14px; font-family: inherit; cursor: pointer; font-weight: 600;">
                            <option value="Pending" ${currentRemark === 'Pending' ? 'selected' : ''}>‚è≥ Pending</option>
                            <option value="Approved" ${currentRemark === 'Approved' ? 'selected' : ''}>‚úÖ Approved</option>
                            <option value="Rejected" ${currentRemark === 'Rejected' ? 'selected' : ''}>‚ùå Rejected</option>
                        </select>
                    </div>
                </div>
                
                ${showCredsButton ? `
                <div style="border-top: 1px solid rgba(32,197,181,0.2); padding-top: 20px; margin-top: 20px;">
                    <h3 style="color: #20c5b5; font-size: 14px; font-weight: 600; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px;">üìÖ Plan Duration Settings</h3>
                    <div class="detail-item">
                        <div class="detail-label">Plan Start Date</div>
                        <input id="planStartDateInput" type="date" value="${planStartDate}" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit; width: 100%;" />
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Plan Maintenance Date</div>
                        <input id="planEndDateInput" type="date" value="${planEndDate}" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit; width: 100%;" />
                    </div>
                </div>
                ` : ''}
                
                ${showCredsButton ? `
                <div style="border-top: 1px solid rgba(32,197,181,0.2); padding-top: 20px; margin-top: 20px;">
                    <h3 style="color: #20c5b5; font-size: 14px; font-weight: 600; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px;">‚úèÔ∏è Edit User Data</h3>
                    <div class="detail-item">
                        <div class="detail-label">Company Name</div>
                        <input id="editBrandName" type="text" value="${lead.brandName || ''}" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit; width: 100%;" />
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Phone Number</div>
                        <input id="editPhone" type="text" value="${lead.phone || ''}" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit; width: 100%;" />
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email Address</div>
                        <input id="editEmail" type="email" value="${lead.email || ''}" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit; width: 100%;" />
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Selected Plan</div>
                        <select id="editPlan" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit; width: 100%;">
                            <option value="">-- Choose a Plan --</option>
                        </select>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Requirements</div>
                        <textarea id="editRequirements" style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit; width: 100%; min-height: 80px; resize: vertical;">${lead.requirements || ''}</textarea>
                    </div>
                    <button id="saveEditBtn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; margin-top: 10px;">üíæ Save Changes</button>
                </div>
                ` : ''}
                
                ${lead.username && lead.password ? `
                    <div style="border-top: 1px solid rgba(32,197,181,0.2); padding-top: 20px; margin-top: 20px; background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 6px;">
                        <h3 style="color: #4caf50; margin-top: 0; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">‚úÖ Login Credentials</h3>
                        <div class="detail-item">
                            <div class="detail-label">Username</div>
                            <div class="detail-value" style="border-left-color: #4caf50; color: #4caf50; font-weight: 600;">${lead.username}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Password</div>
                            <div class="detail-value" style="border-left-color: #4caf50; color: #4caf50; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                <span>${lead.password}</span>
                                <button id="copyPasswordBtn" style="background: rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.5); color: #4caf50; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap;">üìã Copy</button>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${showCredsButton ? `
                    <div id="credsSection" style="margin-top: 15px;">
                        <div id="credsButtonContainer">
                            <button id="generateCredsBtn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">üîê Generate Login Credentials</button>
                        </div>
                        <div id="credsFormContainer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; border: 1px solid rgba(102, 126, 234, 0.3);">
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; color: #20c5b5; font-weight: 600; font-size: 13px; margin-bottom: 6px;">üë§ Username</label>
                                <input id="credsUsername" type="text" placeholder="Enter username" style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit;" />
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; color: #20c5b5; font-weight: 600; font-size: 13px; margin-bottom: 6px;">üîí Password</label>
                                <input id="credsPassword" type="text" placeholder="Enter password" style="width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.1); color: #fff; font-size: 14px; font-family: inherit;" />
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button id="submitCredsBtn" style="flex: 1; background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); border: none; color: white; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">‚úÖ Create Credentials</button>
                                <button id="cancelCredsBtn" style="flex: 1; background: rgba(255, 100, 100, 0.2); border: 1px solid rgba(255, 100, 100, 0.5); color: #ff6464; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">‚ùå Cancel</button>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 15px;">
                    <button id="updateRemarkBtn" style="width: 100%; background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); border: none; color: white; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">üíæ Update Remark</button>
                </div>
            `;
            
            modalBody.innerHTML = detailsHTML;
            
            // Populate plan dropdown for approved users
            if (showCredsButton) {
                populatePlanDropdownForAdmin(lead);
            }
            
            // Add event listeners
            document.getElementById('updateRemarkBtn').addEventListener('click', () => {
                updateLeadRemark(lead.id);
            });
            
            // Add save edit button listener if approved
            if (showCredsButton) {
                const saveEditBtn = document.getElementById('saveEditBtn');
                if (saveEditBtn) {
                    saveEditBtn.addEventListener('click', () => {
                        saveUserDataChanges(lead);
                    });
                }
            }
            
            if (showCredsButton) {
                document.getElementById('generateCredsBtn').addEventListener('click', () => {
                    showCredentialsForm(lead);
                });
                document.getElementById('submitCredsBtn').addEventListener('click', () => {
                    submitCredentials(lead);
                });
                document.getElementById('cancelCredsBtn').addEventListener('click', () => {
                    hideCredentialsForm();
                });
            }
            
            // Add event listener for password copy button in modal (if credentials exist)
            const copyPasswordBtn = document.getElementById('copyPasswordBtn');
            if (copyPasswordBtn) {
                copyPasswordBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyToClipboard(lead.password, copyPasswordBtn);
                });
            }
            
            modal.classList.add('show');
        }
        
        // Function to save user data changes
        async function saveUserDataChanges(lead) {
            const brandName = document.getElementById('editBrandName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const plan = document.getElementById('editPlan').value.trim();
            const requirements = document.getElementById('editRequirements').value.trim();
            const planStartDate = document.getElementById('planStartDateInput').value;
            const planEndDate = document.getElementById('planEndDateInput').value;
            
            if (!brandName || !phone || !email) {
                alert('‚ùå Company Name, Phone, and Email are required');
                return;
            }
            
            if (!planStartDate || !planEndDate) {
                alert('‚ùå Please set both plan start and maintenance dates');
                return;
            }
            
            try {
                const response = await fetch(`/api/lead/${lead.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        brandName, 
                        phone, 
                        email, 
                        plan, 
                        requirements,
                        planStartDate,
                        planEndDate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ User data updated successfully!');
                    closeDetailModal();
                    loadLeads();
                    loadPendingLeads();
                    loadApprovedUsers();
                    loadRejectedLeads();
                } else {
                    alert(`‚ùå Failed to update user data: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating user data:', error);
                alert(`‚ùå Error updating user data: ${error.message}`);
            }
        }
        
        // Function to show credentials form
        function showCredentialsForm(lead) {
            document.getElementById('credsButtonContainer').style.display = 'none';
            document.getElementById('credsFormContainer').style.display = 'block';
            document.getElementById('credsUsername').focus();
        }
        
        // Function to hide credentials form
        function hideCredentialsForm() {
            document.getElementById('credsButtonContainer').style.display = 'block';
            document.getElementById('credsFormContainer').style.display = 'none';
            document.getElementById('credsUsername').value = '';
            document.getElementById('credsPassword').value = '';
        }
        
        // Function to submit custom credentials
        async function submitCredentials(lead) {
            const username = document.getElementById('credsUsername').value.trim();
            const password = document.getElementById('credsPassword').value.trim();
            
            if (!username || !password) {
                alert('‚ùå Please enter both username and password');
                return;
            }
            
            if (username.length < 3) {
                alert('‚ùå Username must be at least 3 characters long');
                return;
            }
            
            if (password.length < 6) {
                alert('‚ùå Password must be at least 6 characters long');
                return;
            }
            
            try {
                const response = await fetch(`/api/lead/${lead.id}/credentials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, email: lead.email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Credentials Created!\n\nUsername: ${username}\nPassword: ${password}\n\nPlease share these with the client.`);
                    hideCredentialsForm();
                    loadApprovedUsers();
                    loadLeads();
                } else {
                    alert(`‚ùå Failed to create credentials: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error creating credentials:', error);
                alert(`‚ùå Error creating credentials: ${error.message}`);
            }
        }
        
        // Function to update lead remark
        async function updateLeadRemark(leadId) {
            const remark = document.getElementById('remarkDropdown').value;
            const adminUsername = localStorage.getItem('adminUsername') || 'Admin';
            
            console.log('Updating remark for lead:', leadId, 'to:', remark);
            
            try {
                const response = await fetch(`/api/lead/${leadId}/remark`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ remark, approvedBy: adminUsername })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    alert(`‚úÖ Lead marked as ${remark}`);
                    
                    // Close modal and reload
                    closeDetailModal();
                    loadLeads();
                    loadPendingLeads();
                    loadApprovedUsers();
                    loadRejectedLeads();
                } else {
                    alert(`‚ùå Failed to update remark: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating remark:', error);
                alert(`‚ùå Error updating remark: ${error.message}`);
            }
        }
        
        // Function to delete a rejected lead
        async function deleteLead(leadId) {
            if (!confirm('Are you sure you want to permanently delete this record?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/lead/${leadId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Lead deleted successfully');
                    loadRejectedLeads();
                } else {
                    alert(`‚ùå Failed to delete lead: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert(`‚ùå Error deleting lead: ${error.message}`);
            }
        }
        
        // Populate plan dropdown in admin edit panel
        async function populatePlanDropdownForAdmin(lead) {
            try {
                const response = await fetch(`/api/plans?t=${Date.now()}`);
                const data = await response.json();
                const plans = data.allPlans || data.plans || [];
                
                const planSelect = document.getElementById('editPlan');
                if (!planSelect) return;
                
                // Clear existing options except the first one
                planSelect.innerHTML = '<option value="">-- Choose a Plan --</option>';
                
                // Add all plans to dropdown
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.name;
                    option.textContent = `${plan.tier} - ${plan.category} (${plan.price})`;
                    planSelect.appendChild(option);
                });
                
                // Set current plan as selected
                if (lead.plan) {
                    planSelect.value = lead.plan;
                }
            } catch (error) {
                console.error('Error loading plans for dropdown:', error);
            }
        }
        
        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.remove('show');
        }
        // Function to copy text to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerText;
                button.innerText = '‚úÖ Copied!';
                button.style.background = 'rgba(76, 175, 80, 0.3)';
                button.style.borderColor = 'rgba(76, 175, 80, 0.7)';
                button.style.color = '#4caf50';
                
                setTimeout(() => {
                    button.innerText = originalText;
                    button.style.background = 'rgba(32,197,181,0.2)';
                    button.style.borderColor = 'rgba(32,197,181,0.5)';
                    button.style.color = '#20c5b5';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err.message);
            });
        }
        
        // Current lead for description modal in approved tab
        let currentLeadForApprovedDesc = null;

        // Function to open description modal for approved users
        function openApprovedUserDescriptionModal(lead) {
            currentLeadForApprovedDesc = lead;
            const modal = document.getElementById('approvedUserDescModal');
            const descTitle = modal.querySelector('.modal-header h2');
            const descHistory = document.getElementById('descriptionHistory');
            document.getElementById('approvedDescTextarea').value = lead.description || '';
            
            // Show current description in history section
            if (lead.description) {
                descHistory.innerHTML = lead.description;
            } else {
                descHistory.innerHTML = '<em style="color: #9fbfc6;">No description added yet</em>';
            }
            
            // Change title and button based on whether description exists
            if (lead.description) {
                descTitle.textContent = 'üìù Update Description';
                document.getElementById('saveApprovedDescBtn').textContent = '‚úÖ Update Description';
            } else {
                descTitle.textContent = 'üìù Add Description';
                document.getElementById('saveApprovedDescBtn').textContent = '‚úÖ Add Description';
            }
            
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
        }

        // Function to close description modal for approved users
        function closeApprovedUserDescriptionModal() {
            const modal = document.getElementById('approvedUserDescModal');
            modal.style.display = 'none';
            modal.classList.add('hidden');
            currentLeadForApprovedDesc = null;
            document.getElementById('approvedDescTextarea').value = '';
        }

        // Function to save description for approved user
        async function saveApprovedUserDescription() {
            if (!currentLeadForApprovedDesc) {
                alert('‚ùå Error: Lead not found');
                return;
            }

            const description = document.getElementById('approvedDescTextarea').value.trim();
            
            try {
                const response = await fetch(`/api/lead/${currentLeadForApprovedDesc.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        brandName: currentLeadForApprovedDesc.brandName,
                        phone: currentLeadForApprovedDesc.phone,
                        email: currentLeadForApprovedDesc.email,
                        plan: currentLeadForApprovedDesc.plan,
                        requirements: currentLeadForApprovedDesc.requirements,
                        description: description,
                        planStartDate: currentLeadForApprovedDesc.planStartDate,
                        planEndDate: currentLeadForApprovedDesc.planEndDate
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Description saved successfully!');
                    // Update the local object
                    currentLeadForApprovedDesc.description = description;
                    closeApprovedUserDescriptionModal();
                    // Reload approved users to update the table
                    loadApprovedUsers();
                } else {
                    alert(`‚ùå Failed to save description: ${data.message}`);
                }
            } catch (error) {
                console.error('Error saving description:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        // Close modal when clicking outside the content
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') {
                closeDetailModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetailModal();
            }
        });

        // Edit Plan Function
        async function editPlanAdmin(planId) {
            // Get the plan element and retrieve data from the data attribute
            const planElement = document.querySelector(`[data-plan-id="${planId}"]`);
            if (!planElement) {
                console.error('Plan element not found');
                alert('Error: Plan not found');
                return;
            }

            const planDataJson = planElement.getAttribute('data-plan-json');
            let planData = null;
            
            try {
                planData = JSON.parse(planDataJson);
            } catch (e) {
                console.error('Error parsing plan data:', e);
                alert('Error loading plan data');
                return;
            }
            
            // Populate form fields with existing plan data
            document.getElementById('planCategory').value = planData.category || '';
            document.getElementById('planTier').value = planData.tier || '';
            document.getElementById('planName').value = planData.name || '';
            document.getElementById('planPrice').value = planData.price || '';
            document.getElementById('planOriginalRate').value = planData.originalRate || '';
            document.getElementById('planOfferPercentage').value = planData.offerPercentage || '';
            document.getElementById('planDesc').value = planData.description || '';
            document.getElementById('planDeliveryTime').value = planData.deliveryTime || '';
            document.getElementById('planIdealFor').value = planData.idealFor || '';
            
            // Populate features
            const featuresContainer = document.getElementById('featuresContainer');
            featuresContainer.innerHTML = '';
            const features = planData.features || [];
            
            features.forEach((feature, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; gap: 8px;';
                div.innerHTML = `
                    <input type="text" class="feature-input" value="${feature.replace(/"/g, '&quot;')}" placeholder="‚úÖ Feature" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                    <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; ${features.length > 1 ? '' : 'display: none;'}">Remove</button>
                `;
                const removeBtn = div.querySelector('.remove-feature-btn');
                removeBtn.onclick = function() {
                    div.remove();
                };
                featuresContainer.appendChild(div);
            });
            
            // Add empty feature slot
            const emptyDiv = document.createElement('div');
            emptyDiv.style.cssText = 'display: flex; gap: 8px;';
            emptyDiv.innerHTML = `
                <input type="text" class="feature-input" placeholder="‚úÖ Feature" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: none;">Remove</button>
            `;
            const removeBtn = emptyDiv.querySelector('.remove-feature-btn');
            removeBtn.onclick = function() {
                emptyDiv.remove();
            };
            featuresContainer.appendChild(emptyDiv);
            
            // Store planId for update
            document.getElementById('addPlanForm').dataset.planId = planId;
            document.getElementById('addPlanForm').dataset.planEditMode = 'true';
            
            // Change button text and styling to "Update Plan"
            const submitBtn = document.querySelector('#addPlanForm button[type="submit"]');
            submitBtn.textContent = '‚úÖ Update Plan';
            submitBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            
            // Add visual highlight to form
            const form = document.getElementById('addPlanForm');
            form.style.border = '2px solid #667eea';
            form.style.borderRadius = '8px';
            form.style.padding = '15px';
            form.style.background = 'rgba(102, 126, 234, 0.05)';
            
            // Scroll to form
            document.getElementById('plansTab').scrollIntoView({ behavior: 'smooth' });
            
            // Show notification
            const msg = document.getElementById('addPlanMsg');
            msg.style.color = '#667eea';
            msg.textContent = '‚úèÔ∏è Edit mode: Make your changes and click "Update Plan"';
            setTimeout(() => {
                msg.textContent = '';
            }, 3000);
        }

        // Delete Plan Function
        async function deletePlanAdmin(planId) {
            if (!confirm('Are you sure you want to delete this plan? This action cannot be undone.')) {
                return;
            }
            
            try {
                const res = await fetch(`/api/plans/${planId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    alert('‚úÖ Plan deleted successfully!');
                    loadCustomPlans();
                } else {
                    alert('‚ùå Error deleting plan: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting plan:', error);
                alert('‚ùå Error deleting plan: ' + error.message);
            }
        }

        // Modify form submission to handle both add and update
        const addPlanForm = document.getElementById('addPlanForm');
        if (addPlanForm) {
            addPlanForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('addPlanMsg');
            msg.textContent = '';
            
            const category = document.getElementById('planCategory').value.trim();
            const tier = document.getElementById('planTier').value.trim();
            const name = document.getElementById('planName').value.trim();
            const price = document.getElementById('planPrice').value.trim();
            const originalRate = document.getElementById('planOriginalRate').value.trim();
            const offerPercentage = document.getElementById('planOfferPercentage').value.trim();
            const description = document.getElementById('planDesc').value.trim();
            const deliveryTime = document.getElementById('planDeliveryTime').value.trim();
            const idealFor = document.getElementById('planIdealFor').value.trim();
            const features = Array.from(document.querySelectorAll('.feature-input'))
                .map(input => input.value.trim())
                .filter(value => value.length > 0);
            
            if (!category || !tier || !name || !price) {
                msg.style.color = '#ffb3b3';
                msg.textContent = 'All required fields must be filled';
                return;
            }
            
            if (features.length === 0) {
                msg.style.color = '#ffb3b3';
                msg.textContent = 'Please add at least one feature';
                return;
            }
            
            try {
                const planId = parseInt(document.getElementById('addPlanForm').dataset.planId) || null;
                const method = planId ? 'PUT' : 'POST';
                const url = planId ? `/api/plans/${planId}` : '/api/plans';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category, tier, name, price, originalRate, offerPercentage, description, features, deliveryTime, idealFor })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    msg.style.color = '#9fbfc6';
                    msg.textContent = planId ? '‚úÖ Plan updated successfully!' : '‚úÖ Plan added successfully!';
                    document.getElementById('addPlanForm').reset();
                    delete document.getElementById('addPlanForm').dataset.planId;
                    delete document.getElementById('addPlanForm').dataset.planEditMode;
                    
                    // Reset form styling
                    const form = document.getElementById('addPlanForm');
                    form.style.border = 'none';
                    form.style.background = 'transparent';
                    form.style.padding = '0';
                    
                    const submitBtn = document.querySelector('#addPlanForm button[type="submit"]');
                    submitBtn.textContent = 'Add Plan';
                    submitBtn.style.background = 'linear-gradient(135deg, #20c5b5, #0db8a1)';
                    
                    document.getElementById('featuresContainer').innerHTML = `
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="feature-input" placeholder="‚úÖ Feature 1" style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 13px; font-family: inherit;" />
                            <button type="button" class="remove-feature-btn" style="background: rgba(255,100,100,0.2); border: 1px solid rgba(255,100,100,0.5); color: #ff6464; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; display: none;">Remove</button>
                        </div>
                    `;
                    setTimeout(() => loadCustomPlans(), 500);
                } else {
                    msg.style.color = '#ffb3b3';
                    msg.textContent = '‚ùå ' + (data.message || 'Error saving plan');
                }
            } catch (error) {
                msg.style.color = '#ffb3b3';
                msg.textContent = '‚ùå Error: ' + error.message;
            }
            });
        }
    </script>

    <!-- Approved User Description Modal -->
    <div id="approvedUserDescModal" class="modal" style="background: rgba(0, 0, 0, 0.95);">
        <div class="modal-content" style="max-width: 95%; width: 95%; max-height: 95vh; height: 95vh; display: flex; flex-direction: column; padding: 0;">
            <div class="modal-header" style="padding: 25px 30px; flex-shrink: 0;">
                <h2 style="font-size: 28px;">üìù Add Description</h2>
                <button type="button" class="modal-close" onclick="closeApprovedUserDescriptionModal()">√ó</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column;">
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(32, 197, 181, 0.1); border: 1px solid rgba(32, 197, 181, 0.3); border-radius: 6px;">
                    <p style="color: #20c5b5; font-weight: 600; font-size: 13px; margin: 0 0 8px 0;">Current Description History:</p>
                    <div id="descriptionHistory" style="color: #cfd8df; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; min-height: 40px;">
                        <em style="color: #9fbfc6;">No description added yet</em>
                    </div>
                </div>
                <label style="display: block; color: #20c5b5; font-weight: 600; font-size: 14px; margin-bottom: 15px;">Write or update description for this user:</label>
                <textarea id="approvedDescTextarea" style="padding: 15px; border-radius: 8px; border: 2px solid rgba(32,197,181,0.5); background: rgba(32,197,181,0.05); color: #fff; font-size: 15px; font-family: 'Inter', sans-serif; width: 100%; flex: 1; resize: none; line-height: 1.6;" placeholder="Enter detailed description..."></textarea>
                <div style="display: flex; gap: 15px; margin-top: 20px; flex-shrink: 0;">
                    <button id="saveApprovedDescBtn" style="flex: 1; background: linear-gradient(135deg, #20c5b5 0%, #0db8a1 100%); border: none; color: white; padding: 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">‚úÖ Add Description</button>
                    <button type="button" onclick="closeApprovedUserDescriptionModal()" style="flex: 1; background: rgba(255,100,100,0.2); border: 2px solid rgba(255,100,100,0.5); color: #ff6464; padding: 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">‚ùå Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add event listener for approved user description save button
        document.getElementById('saveApprovedDescBtn').addEventListener('click', () => {
            saveApprovedUserDescription();
        });
    </script>
</body>
</html>
